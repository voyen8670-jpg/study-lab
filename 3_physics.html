<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Th·ªßy Tri·ªÅu v√† Pha TrƒÉng</title>
<style>
body {
  font-family: "Segoe UI", sans-serif;
  background: radial-gradient(ellipse at center, #020111 0%, #000010 100%);
  color:#fff;
  margin:0;
  padding:0;
  overflow:hidden;
}

.container {
  display:flex;
  height:100vh;
}

/* V√πng m√¥ ph·ªèng b√™n tr√°i */
.left-panel {
  flex:3;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  border-right:2px solid rgba(255,255,255,0.15);
  position:relative;
  background: radial-gradient(circle at top, #0a1436, #000010);
}

.title {
  font-size:22px;
  color:#4ED7F1;
  margin-bottom:20px;
  text-shadow:0 0 12px #00d4ff;
  font-weight:bold;
}

.space {
  position:relative;
  width:600px;   
  height:600px;
  border-radius:50%;
  overflow:hidden;
  background: radial-gradient(circle at center, #000 70%, #020418 100%);
  box-shadow:0 0 100px #000 inset, 0 0 40px rgba(0,200,255,0.25);
}

/* C√°c thi√™n th·ªÉ */
.sun, .earth, .moon {
  position:absolute;
  border-radius:50%;
}

.sun {
  width:110px;
  height:110px;
  border-radius:50%;
  background:
    radial-gradient(circle at 30% 30%, #fff9d9 0%, #ffe066 35%, #ff9a1f 70%, #ff6a00 100%);
  top:50%;
  left:6%;
  transform:translateY(-50%);
  box-shadow:
    0 0 30px #fff6c7,
    0 0 70px #ffd54f,
    0 0 140px #ff9100,
    0 0 200px rgba(255,150,0,0.7);
  z-index:2;
}

/* Tr√°i ƒë·∫•t */
.earth {
  width: 90px;
  height: 90px;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  z-index: 3;
  border-radius: 50%;
  box-shadow: 
    inset -12px -12px 20px rgba(0,0,0,0.7),
    0 0 28px rgba(0,200,255,0.35);
  background-blend-mode: screen, multiply;
}

.moon {
  width:50px;
  height:50px;
  border-radius:50%;
  background: radial-gradient(circle at 30% 30%, #e0e0e0 0%, #c0c0c0 40%, #8a8a8a 80%);
  box-shadow:0 0 15px rgba(255,255,255,0.9), inset -6px -6px 12px rgba(0,0,0,0.5);
  transition:all 0.3s;
  z-index:4;
}

/* Th·ªßy tri·ªÅu */
.tide {
  width:130px;
  height:25px;
  background:linear-gradient(to top,#2962ff,#4da6ff);
  position:absolute;
  bottom:-30px;
  left:50%;
  transform:translateX(-50%);
  border-radius:50px;
  box-shadow:0 0 16px #5393ff;
  animation:wave 3s infinite ease-in-out;
}
@keyframes wave {
  0%,100% { transform:translateX(-50%) scaleX(1); }
  50% { transform:translateX(-50%) scaleX(1.2); }
}

/* Thanh ƒëi·ªÅu khi·ªÉn b√™n ph·∫£i */
.right-panel {
  flex:1;
  display:flex;
  flex-direction:column;
  justify-content:flex-start;
  align-items:center;
  padding:15px;
  background: rgba(255,255,255,0.05);
  backdrop-filter: blur(12px);
  height:100%;
}

.controls {
  display:flex;
  flex-direction:column;
  width:100%;
  height:100%;
  justify-content:flex-start;
}

.controls button {
  padding:12px;
  margin:8px 0;
  font-size:15px;
  cursor:pointer;
  border-radius:8px;
  border:none;
  background:linear-gradient(135deg,#4ED7F1,#2196F3);
  color:#fff;
  font-weight:bold;
  letter-spacing:0.5px;
  box-shadow:0 4px 10px rgba(0,0,0,0.3);
  transition:0.3s;
}
.controls button:hover {
  background:linear-gradient(135deg,#64e9ff,#1e88e5);
  transform:translateY(-2px);
}

.description {
  margin-top:12px;
  width:100%;
  background:rgba(255,255,255,0.08);
  padding:12px;
  border-radius:12px;
  border:1px solid rgba(255,255,255,0.2);
  font-size:14px;
  text-align:left;
  line-height:1.4em;
  box-shadow:0 2px 8px rgba(0,0,0,0.25);
}

/* Gi·∫£i th√≠ch khoa h·ªçc */
.explanation {
  margin-top:16px;
  padding:14px;
  background:rgba(255,255,255,0.06);
  border-radius:12px;
  border:1px solid rgba(255,255,255,0.15);
  font-size:14px;
  line-height:1.5em;
  text-align:justify;
  box-shadow:0 2px 8px rgba(0,0,0,0.25);
}
.explanation h3 {
  margin-top:0;
  color:#4ED7F1;
  font-size:16px;
  text-align:center;
}
</style>
</head>
<body>

<div class="container">
  <div class="left-panel">
    <div class="title">üåä Th·ªßy Tri·ªÅu & Pha TrƒÉng 3D √Ånh S√°ng M∆∞·ª£t</div>
    <div class="space">
      <div class="sun"></div>
      <div class="earth" id="earth">
        <div class="tide" id="tide"></div>
      </div>
      <div class="moon" id="moon"></div>
    </div>
  </div>

  <div class="right-panel">
    <div class="controls">
      <button onclick="setManualPhase('newMoon')">üåë TrƒÉng non</button>
      <button onclick="setManualPhase('fullMoon')">üåï TrƒÉng tr√≤n</button>
      <button onclick="setManualPhase('firstQuarter')">üåì Th∆∞·ª£ng huy·ªÅn</button>
      <button onclick="setManualPhase('lastQuarter')">üåó H·∫° huy·ªÅn</button>
      <button onclick="resetManual()">üîÑ T·ª± ƒë·ªông</button>
      <div class="description" id="description">üîÑ Ch·ªçn pha TrƒÉng ho·∫∑c b·∫≠t ch·∫ø ƒë·ªô t·ª± ƒë·ªông.</div>
      
      <div class="explanation">
        <h3>üìñ Gi·∫£i th√≠ch</h3>
        <p><b>Tri·ªÅu c∆∞·ªùng</b> xu·∫•t hi·ªán khi Tr√°i ƒê·∫•t, M·∫∑t TrƒÉng v√† M·∫∑t Tr·ªùi g·∫ßn nh∆∞ th·∫≥ng h√†ng (trƒÉng non üåë v√† trƒÉng tr√≤n üåï).  
        L·ª±c h√∫t k·∫øt h·ª£p c·ªßa M·∫∑t TrƒÉng v√† M·∫∑t Tr·ªùi l√†m th·ªßy tri·ªÅu d√¢ng cao nh·∫•t.</p>
        <p><b>Tri·ªÅu k√©m</b> x·∫£y ra khi TrƒÉng ·ªü pha th∆∞·ª£ng huy·ªÅn üåì hay h·∫° huy·ªÅn üåó,  
        l·ª±c h√∫t c·ªßa M·∫∑t TrƒÉng vu√¥ng g√≥c v·ªõi l·ª±c h√∫t M·∫∑t Tr·ªùi, l√†m tri·ªÅu th·∫•p h∆°n.</p>
      </div>
    </div>
  </div>
</div>

<script>
const moon = document.getElementById('moon');
const tide = document.getElementById('tide');
const description = document.getElementById('description');
const space = document.querySelector('.space');
const earth = document.getElementById('earth');

let autoMode = true, angle=0;

function getEarthCenter(){
  const spaceRect = space.getBoundingClientRect();
  const earthRect = earth.getBoundingClientRect();
  return { x: earthRect.left - spaceRect.left + earthRect.width/2, y: earthRect.top - spaceRect.top + earthRect.height/2 };
}

function updateScene(){
  const center = getEarthCenter();
  const radius = 220;
  const rad = angle*Math.PI/180;
  const inclination = 22*Math.sin(rad);

  const moonX = center.x + radius*Math.cos(rad);
  const moonY = center.y + radius*Math.sin(rad) + inclination;
  moon.style.left = moonX - moon.offsetWidth/2 + "px";
  moon.style.top = moonY - moon.offsetHeight/2 + "px";

  // M·∫∑t trƒÉng
  const moonLightAngle = (rad + Math.PI) % (2*Math.PI);
  moon.style.background = `radial-gradient(circle at ${50 + 50*Math.cos(moonLightAngle)}% 50%, #f4f4f4 55%, #888 85%, #222 100%)`;

  // Tr√°i ƒë·∫•t
  const earthLightAngle = (rad + Math.PI) % (2*Math.PI);
  const earthLightShadow = `radial-gradient(circle at ${50 + 50*Math.cos(earthLightAngle)}% 50%, rgba(255,255,255,0.9) 40%, rgba(0,0,20,0.95) 100%)`;
  const earthTexture = `
    radial-gradient(circle at 30% 40%, rgba(34,139,34,0.9) 0%, transparent 35%),
    radial-gradient(circle at 70% 60%, rgba(0,128,0,0.8) 0%, transparent 40%),
    radial-gradient(circle at 50% 75%, rgba(0,100,0,0.7) 0%, transparent 45%),
    radial-gradient(circle at 60% 40%, #1e90ff 0%, #001a33 85%)
  `;
  earth.style.background = earthTexture + "," + earthLightShadow;

  // Th·ªßy tri·ªÅu
  const tideHeight = 25 + 45*Math.abs(Math.cos(rad));
  tide.style.height = tideHeight + "px";

  // M√¥ t·∫£ ƒë·ªông
  if(angle%360<10||angle%360>350){description.innerHTML="üåë TrƒÉng non: Tri·ªÅu c∆∞·ªùng";}
  else if(Math.abs((angle%360)-180)<10){description.innerHTML="üåï TrƒÉng tr√≤n: Tri·ªÅu c∆∞·ªùng";}
  else if(Math.abs((angle%360)-270)<10){description.innerHTML="üåó H·∫° huy·ªÅn: Tri·ªÅu k√©m";}
  else if(Math.abs((angle%360)-90)<10){description.innerHTML="üåì Th∆∞·ª£ng huy·ªÅn: Tri·ªÅu k√©m";}

  if(autoMode){angle+=0.5; requestAnimationFrame(updateScene);}
}

function setManualPhase(phase){
  autoMode=false;
  switch(phase){
    case 'newMoon': angle=0; break;
    case 'fullMoon': angle=180; break;
    case 'firstQuarter': angle=90; break;
    case 'lastQuarter': angle=270; break;
  }
  updateScene();
}

function resetManual(){
  autoMode=true;
  requestAnimationFrame(updateScene);
}

window.onload = ()=>{updateScene();};
</script>

  <!-- N√∫t m·ªü chat -->
<div id="ai-toggle" title="Tr·ª£ l√Ω AI">üí¨</div>

<!-- Khung chat -->
<div id="ai-chat">
  <div class="ai-header">
    <span>Tr·ª£ l√Ω AI</span>
    <button id="ai-close">√ó</button>
  </div>
  <div id="ai-body" class="ai-body"></div>
  <div class="ai-input">
    <input id="ai-text" type="text" placeholder="H·ªèi v·ªÅ th√≠ nghi·ªám n√†y..." />
    <button id="ai-send">‚û§</button>
  </div>
</div>

<style>
/* N√∫t m·ªü */
#ai-toggle {
  position: fixed;
  bottom: 20px;
  right: 20px;
  background: linear-gradient(135deg, #00eaff, #008cff);
  color: #000;
  font-size: 22px;
  padding: 12px;
  border-radius: 50%;
  box-shadow: 0 0 12px #00eaff;
  cursor: pointer;
  transition: transform 0.3s;
  z-index: 999999;
}
#ai-toggle:hover {
  transform: scale(1.15);
}

/* Khung chat */
#ai-chat {
  position: fixed;
  bottom: 80px;
  right: 20px;
  width: 300px;
  background: rgba(0, 0, 0, 0.92);
  border: 1px solid #00eaff;
  border-radius: 15px;
  box-shadow: 0 0 20px #00eaff44;
  display: none;
  flex-direction: column;
  overflow: hidden;
  z-index: 999998;
  transition: all 0.3s ease;
}
#ai-chat.active {
  display: flex !important;
  animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
  from {
    opacity: 0;
    transform: translateY(10px) scale(0.95);
  }
  to {
    opacity: 1;
    transform: translateY(0) scale(1);
  }
}

.ai-header {
  background: #00eaff;
  color: #000;
  font-weight: bold;
  padding: 6px 10px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.ai-header button {
  border: none;
  background: transparent;
  font-size: 20px;
  cursor: pointer;
  color: #000;
}

.ai-body {
  padding: 10px;
  font-size: 13px;
  color: white;
  height: 260px;
  overflow-y: auto;
  background: rgba(255, 255, 255, 0.05);
}
.ai-msg,
.user-msg {
  margin: 6px 0;
  padding: 8px 10px;
  border-radius: 8px;
  line-height: 1.4;
  max-width: 80%;
}
.ai-msg {
  background: #00eaff22;
  text-align: left;
}
.user-msg {
  background: #0088ff44;
  text-align: right;
  margin-left: auto;
}

.ai-input {
  display: flex;
  border-top: 1px solid #00eaff;
}
.ai-input input {
  flex: 1;
  padding: 8px;
  border: none;
  background: transparent;
  color: white;
}
.ai-input button {
  background: #00eaff;
  color: #000;
  border: none;
  padding: 0 12px;
  cursor: pointer;
}
.ai-input button:hover {
  background: #00cfff;
}

canvas, iframe {
  pointer-events: none !important;
}
</style>

<script>
document.addEventListener("DOMContentLoaded", function () {
  console.log("‚úÖ AI chat script loaded");
  const toggle = document.getElementById("ai-toggle");
  const chat = document.getElementById("ai-chat");
  const closeBtn = document.getElementById("ai-close");
  const sendBtn = document.getElementById("ai-send");
  const input = document.getElementById("ai-text");
  const body = document.getElementById("ai-body");
  let greeted = false;

  if (!toggle || !chat) {
    console.error("‚ùå Kh√¥ng t√¨m th·∫•y ph·∫ßn t·ª≠ chat!");
    return;
  }

  // M·ªü & ch√†o
  toggle.addEventListener("click", () => {
    console.log("üí¨ N√∫t chat ƒë∆∞·ª£c b·∫•m");
    chat.classList.toggle("active");
    if (chat.classList.contains("active") && !greeted) {
      greeted = true;
      setTimeout(() => {
        body.innerHTML += `<div class='ai-msg'>üëã Xin ch√†o! M√¨nh l√† tr·ª£ l√Ω AI c·ªßa ph√≤ng th√≠ nghi·ªám.<br>
        M√¨nh c√≥ th·ªÉ gi·∫£i ƒë√°p th·∫Øc m·∫Øc c·ªßa b·∫°n v·ªÅ th√≠ nghi·ªám n√†y</b> nh√©!</div>`;
        body.scrollTop = body.scrollHeight;
      }, 200);
    }
  });

  // ‚ùå ƒê√≥ng
  closeBtn.addEventListener("click", () => {
    chat.classList.remove("active");
    console.log("‚ùå Chat b·ªã ƒë√≥ng");
  });

  // ‚úâÔ∏è G·ª≠i tin nh·∫Øn
  async function sendMessage() {
    const msg = input.value.trim();
    if (!msg) return;
    body.innerHTML += `<div class='user-msg'>${msg}</div>`;
    input.value = "";
    body.scrollTop = body.scrollHeight;

    body.innerHTML += `<div class='ai-msg' id='typing'>ƒêang suy nghƒ©...</div>`;
    body.scrollTop = body.scrollHeight;

    try {
      const res = await fetch("/api/explain", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ question: msg })
      });
      const data = await res.json();
      document.getElementById("typing").remove();
      body.innerHTML += `<div class='ai-msg'>${data.answer}</div>`;
    } catch (e) {
      console.warn("‚ö†Ô∏è L·ªói API:", e);
      document.getElementById("typing").remove();
      body.innerHTML += `<div class='ai-msg'>‚ö†Ô∏è Kh√¥ng th·ªÉ k·∫øt n·ªëi t·ªõi m√°y ch·ªß AI.</div>`;
    }

    body.scrollTop = body.scrollHeight;
  }

  sendBtn.addEventListener("click", sendMessage);
  input.addEventListener("keydown", (e) => {
    if (e.key === "Enter") sendMessage();
  });
});
</script>
</body>
</html>
