<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Sim: I‚ÇÇ + Amylose (h·ªì tinh b·ªôt)</title>
  <style>
  :root{
    --bg:#071227; --panel:#0b1520;
    --iodineTop:rgb(180,110,40); --iodineBottom:rgb(120,60,20);
    --starchTop:#eef3ff; --starchBottom:#e9f4ff;
    --blue:#3a0078;
  }
  body{font-family:Inter, Arial, Helvetica, sans-serif;
       background:linear-gradient(180deg,#031426,#071227);
       color:#e8f6ff;margin:0;padding:18px;
       display:flex;justify-content:center}
  .wrap{max-width:980px;width:100%}
  h1{margin:0 0 8px;font-size:18px}
  .bench{display:flex;gap:28px;align-items:flex-end;justify-content:center;margin:16px 0}
  .tube{width:100px;height:300px;border:2px solid rgba(255,255,255,0.08);
        border-radius:18px 18px 30px 30px;position:relative;overflow:hidden;
        background:rgba(255,255,255,0.02)}
  .neck{position:absolute;top:-28px;left:calc(50% - 22px);width:44px;height:50px;
        border-radius:8px;background:rgba(255,255,255,0.03)}
  .liquid{
        position:absolute;left:0;right:0;bottom:0;height:0;
        transition: height 1.5s linear, background-color 4s ease;
        border-radius:0 0 28px 28px
  }
  .label{position:absolute;top:6px;left:10px;font-size:13px;color:#cfe3ff}
  .caption{text-align:center;margin-top:6px;font-size:14px}
  .controls{margin-top:12px;display:flex;gap:8px;flex-wrap:wrap}
  button{padding:8px 12px;border-radius:8px;border:1px solid rgba(255,255,255,0.1);
         background:rgba(255,255,255,0.04);color:#e6f5ff;cursor:pointer}
  table{width:100%;border-collapse:collapse;margin-top:12px;color:#dfeeff}
  td,th{padding:6px;border-bottom:1px dashed rgba(255,255,255,0.08);
        font-size:13px;text-align:left}
  .explain{margin-top:12px;background:rgba(255,255,255,0.03);
           padding:10px;border-radius:8px;font-size:14px;line-height:1.5}
  pre{background:transparent;color:#dfeeff;padding:6px;font-size:13px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>M√¥ ph·ªèng: I‚ÇÇ + Amylose (h·ªì tinh b·ªôt)</h1>
    <div class="bench">
      <div style="display:flex;flex-direction:column;align-items:center">
        <div class="tube" id="tubeA">
          <div class="neck"></div>
          <div class="label">·ªêng A</div>
          <div class="liquid" id="liqA" 
               style="background:linear-gradient(180deg,var(--iodineTop),var(--iodineBottom))"></div>
        </div>
        <div class="caption">
          I‚ÇÇ<br><strong>0.1 M, <span id="capA">20</span> mL</strong>
        </div>
      </div>
      <div style="display:flex;flex-direction:column;align-items:center">
        <div class="tube" id="tubeB">
          <div class="neck"></div>
          <div class="label">·ªêng B</div>
          <div class="liquid" id="liqB" 
               style="background:linear-gradient(180deg,var(--starchTop),var(--starchBottom))"></div>
        </div>
        <div class="caption">
          Amylose (h·ªì tinh b·ªôt)<br><strong>0.5 M, <span id="capB">15</span> mL</strong>
        </div>
      </div>
      <div style="display:flex;flex-direction:column;align-items:center">
        <div class="tube" id="tubeC">
          <div class="neck"></div>
          <div class="label">·ªêng C</div>
          <div class="liquid" id="liqC" 
               style="background-color:var(--starchBottom)"></div>
        </div>
        <div class="caption">
          H·ªón h·ª£p<br><strong><span id="capC">0</span> mL</strong>
        </div>
      </div>
    </div>

    <div class="controls">
      <button id="pourA">R√≥t A ‚Üí C</button>
      <button id="pourB">R√≥t B ‚Üí C</button>
      <button id="heat">ƒêun C</button>
      <button id="cool">L√†m ngu·ªôi C</button>
      <button id="reset">ƒê·∫∑t l·∫°i</button>
    </div>

    <table>
      <thead>
        <tr><th>·ªêng</th><th>N·ªìng ƒë·ªô</th><th>Th·ªÉ t√≠ch</th></tr>
      </thead>
      <tbody>
        <tr><td>·ªêng A (I‚ÇÇ)</td><td>0.1 M</td><td id="volA">20 mL</td></tr>
        <tr><td>·ªêng B (Amylose)</td><td>0.5 M</td><td id="volB">15 mL</td></tr>
        <tr><td>·ªêng C (H·ªón h·ª£p)</td><td>‚Äî</td><td id="volC">0 mL</td></tr>
      </tbody>
    </table>

    <div class="explain" id="explain">
      <strong>Gi·∫£i th√≠ch theo thao t√°c</strong>
      <div id="explainText" style="margin-top:6px">
        Chu·∫©n b·ªã: A ‚Äî I‚ÇÇ (0.1 M, 20 mL, n√¢u); 
        B ‚Äî Amylose (0.5 M, 15 mL, kh√¥ng m√†u).<br>
        R√≥t A v√†/ho·∫∑c B v√†o C. Khi c√≥ c·∫£ hai, dung d·ªãch s·∫Ω chuy·ªÉn d·∫ßn sang xanh t√≠m.
      </div>
    </div>

    <div class="explain" style="margin-top:8px">
      <strong>Ph∆∞∆°ng tr√¨nh (r√∫t g·ªçn):</strong>
      <pre>I‚ÇÇ + Amylose (h·ªì tinh b·ªôt) ‚áå H·ª£p ch·∫•t m√†u xanh t√≠m</pre>
    </div>
  </div>

<script>
const INIT = {A:20, B:15, C:0};
let A = INIT.A, B = INIT.B, C = INIT.C;
let hasIodine = false, hasStarch = false, isHeating = false;

const liqA = document.getElementById('liqA');
const liqB = document.getElementById('liqB');
const liqC = document.getElementById('liqC');
const capA = document.getElementById('capA');
const capB = document.getElementById('capB');
const capC = document.getElementById('capC');
const volA = document.getElementById('volA');
const volB = document.getElementById('volB');
const volC = document.getElementById('volC');
const explainText = document.getElementById('explainText');

function volToPct(v){ return Math.min(v/40,0.85)*100 + '%'; }
function refreshAll(){
  liqA.style.height = volToPct(A);
  liqB.style.height = volToPct(B);
  liqC.style.height = volToPct(C);
  capA.textContent = Math.round(A);
  capB.textContent = Math.round(B);
  capC.textContent = Math.round(C);
  volA.textContent = Math.round(A)+' mL';
  volB.textContent = Math.round(B)+' mL';
  volC.textContent = Math.round(C)+' mL';
  updateCColor();
}

function updateCColor(){
  if(C<=0){  
    liqC.style.backgroundColor = '#e9f4ff'; // tr·∫Øng nh·∫°t
    return;
  }
  if(isHeating){
    liqC.style.backgroundColor = '#ffffff'; // m·∫•t m√†u
  } else if(hasIodine && hasStarch){
    liqC.style.backgroundColor = '#3a0078'; // xanh t√≠m
  } else if(hasIodine){
    liqC.style.backgroundColor = '#8c4a1f'; // n√¢u
  } else {
    liqC.style.backgroundColor = '#e9f4ff'; // trong su·ªët
  }
}

function animatePour(source){
  if(isHeating) isHeating = false;
  let amount = (source==='A') ? A : B;
  if(amount <= 0){ explainText.innerHTML = `<strong>·ªêng ${source} ƒë√£ r·ªóng.</strong>`; return; }
  if(source==='A') hasIodine = true; 
  if(source==='B') hasStarch = true;
  explainText.innerHTML = `<strong>ƒêang r√≥t ${source} v√†o ·ªëng C...</strong>`;
  const steps = 15; const dt = 100; let step = 0; const delta = amount / steps;
  const iv = setInterval(()=>{
    step++;
    if(source==='A'){ const transfer = Math.min(delta, A); A -= transfer; C += transfer; }
    else { const transfer = Math.min(delta, B); B -= transfer; C += transfer; }
    refreshAll();
    if(step>=steps){ clearInterval(iv); explainAfterPour(source); }
  }, dt);
}

function explainAfterPour(source){
  if(source==='A'){
    explainText.innerHTML = `<strong>ƒê√£ r√≥t I‚ÇÇ v√†o ·ªëng C.</strong><br>·ªêng C c√≥ m√†u n√¢u c·ªßa dung d·ªãch I‚ÇÇ. N·∫øu c√≥ Amylose, s·∫Ω xu·∫•t hi·ªán m√†u xanh t√≠m.`;
  } else {
    if(hasIodine){
      explainText.innerHTML = `<strong>ƒê√£ r√≥t Amylose v√†o ·ªëng C.</strong><br>Ph·ª©c I‚ÇÇ - Amylose h√¨nh th√†nh, dung d·ªãch chuy·ªÉn d·∫ßn sang xanh t√≠m.`;
    } else {
      explainText.innerHTML = `<strong>ƒê√£ r√≥t Amylose v√†o ·ªëng C.</strong><br>·ªêng C trong su·ªët; ph·∫£n ·ª©ng c·∫ßn c√≥ I‚ÇÇ.`;
    }
  }
}

function heatC(){
  if(C<=0){ explainText.innerHTML = `<strong>·ªêng C r·ªóng.</strong> R√≥t ch·∫•t tr∆∞·ªõc khi ƒëun.`; return; }
  isHeating = true;
  updateCColor();
  explainText.innerHTML = `<strong>ƒêang ƒëun ·ªëng C...</strong><br>Ph·ª©c I‚ÇÇ - Amylose b·ªã ph√° v·ª°, m√†u xanh t√≠m m·∫•t d·∫ßn.`;
}

function coolC(){
  if(C<=0){ explainText.innerHTML = `<strong>·ªêng C r·ªóng.</strong>`; return; }
  if(hasIodine && hasStarch){
    isHeating = false;
    updateCColor();
    explainText.innerHTML = `<strong>·ªêng C ngu·ªôi l·∫°i.</strong><br>Ph·ª©c I‚ÇÇ - Amylose t√°i t·∫°o, m√†u xanh t√≠m xu·∫•t hi·ªán tr·ªü l·∫°i.`;
  } else {
    explainText.innerHTML = `<strong>L√†m ngu·ªôi ·ªëng C.</strong><br>Kh√¥ng c√≥ ƒë·ªß I‚ÇÇ v√† Amylose ƒë·ªÉ t·∫°o m√†u xanh t√≠m.`;
  }
}

document.getElementById('pourA').addEventListener('click', ()=>{ animatePour('A'); });
document.getElementById('pourB').addEventListener('click', ()=>{ animatePour('B'); });
document.getElementById('heat').addEventListener('click', heatC);
document.getElementById('cool').addEventListener('click', coolC);
document.getElementById('reset').addEventListener('click', ()=>{
  A=INIT.A;B=INIT.B;C=INIT.C;hasIodine=false;hasStarch=false;isHeating=false;
  liqC.style.backgroundColor='#e9f4ff';
  explainText.innerHTML=`Chu·∫©n b·ªã: A ‚Äî I‚ÇÇ (0.1 M, 20 mL, n√¢u); B ‚Äî Amylose (0.5 M, 15 mL, kh√¥ng m√†u).<br>R√≥t A v√†/ho·∫∑c B v√†o C.`;
  refreshAll();
});

refreshAll();
</script>

  <!-- N√∫t m·ªü chat -->
<div id="ai-toggle" title="Tr·ª£ l√Ω AI">üí¨</div>

<!-- Khung chat -->
<div id="ai-chat">
  <div class="ai-header">
    <span>Tr·ª£ l√Ω AI</span>
    <button id="ai-close">√ó</button>
  </div>
  <div id="ai-body" class="ai-body"></div>
  <div class="ai-input">
    <input id="ai-text" type="text" placeholder="H·ªèi v·ªÅ th√≠ nghi·ªám n√†y..." />
    <button id="ai-send">‚û§</button>
  </div>
</div>

<style>
/* N√∫t m·ªü */
#ai-toggle {
  position: fixed;
  bottom: 20px;
  right: 20px;
  background: linear-gradient(135deg, #00eaff, #008cff);
  color: #000;
  font-size: 22px;
  padding: 12px;
  border-radius: 50%;
  box-shadow: 0 0 12px #00eaff;
  cursor: pointer;
  transition: transform 0.3s;
  z-index: 999999;
}
#ai-toggle:hover {
  transform: scale(1.15);
}

/* Khung chat */
#ai-chat {
  position: fixed;
  bottom: 80px;
  right: 20px;
  width: 300px;
  background: rgba(0, 0, 0, 0.92);
  border: 1px solid #00eaff;
  border-radius: 15px;
  box-shadow: 0 0 20px #00eaff44;
  display: none;
  flex-direction: column;
  overflow: hidden;
  z-index: 999998;
  transition: all 0.3s ease;
}
#ai-chat.active {
  display: flex !important;
  animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
  from {
    opacity: 0;
    transform: translateY(10px) scale(0.95);
  }
  to {
    opacity: 1;
    transform: translateY(0) scale(1);
  }
}

.ai-header {
  background: #00eaff;
  color: #000;
  font-weight: bold;
  padding: 6px 10px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.ai-header button {
  border: none;
  background: transparent;
  font-size: 20px;
  cursor: pointer;
  color: #000;
}

.ai-body {
  padding: 10px;
  font-size: 13px;
  color: white;
  height: 260px;
  overflow-y: auto;
  background: rgba(255, 255, 255, 0.05);
}
.ai-msg,
.user-msg {
  margin: 6px 0;
  padding: 8px 10px;
  border-radius: 8px;
  line-height: 1.4;
  max-width: 80%;
}
.ai-msg {
  background: #00eaff22;
  text-align: left;
}
.user-msg {
  background: #0088ff44;
  text-align: right;
  margin-left: auto;
}

.ai-input {
  display: flex;
  border-top: 1px solid #00eaff;
}
.ai-input input {
  flex: 1;
  padding: 8px;
  border: none;
  background: transparent;
  color: white;
}
.ai-input button {
  background: #00eaff;
  color: #000;
  border: none;
  padding: 0 12px;
  cursor: pointer;
}
.ai-input button:hover {
  background: #00cfff;
}

canvas, iframe {
  pointer-events: none !important;
}
</style>

<script>
document.addEventListener("DOMContentLoaded", function () {
  console.log("‚úÖ AI chat script loaded");
  const toggle = document.getElementById("ai-toggle");
  const chat = document.getElementById("ai-chat");
  const closeBtn = document.getElementById("ai-close");
  const sendBtn = document.getElementById("ai-send");
  const input = document.getElementById("ai-text");
  const body = document.getElementById("ai-body");
  let greeted = false;

  if (!toggle || !chat) {
    console.error("‚ùå Kh√¥ng t√¨m th·∫•y ph·∫ßn t·ª≠ chat!");
    return;
  }

  // M·ªü & ch√†o
  toggle.addEventListener("click", () => {
    console.log("üí¨ N√∫t chat ƒë∆∞·ª£c b·∫•m");
    chat.classList.toggle("active");
    if (chat.classList.contains("active") && !greeted) {
      greeted = true;
      setTimeout(() => {
        body.innerHTML += `<div class='ai-msg'>üëã Xin ch√†o! M√¨nh l√† tr·ª£ l√Ω AI c·ªßa ph√≤ng th√≠ nghi·ªám.<br>
        M√¨nh c√≥ th·ªÉ gi·∫£i ƒë√°p th·∫Øc m·∫Øc c·ªßa b·∫°n v·ªÅ th√≠ nghi·ªám n√†y</b> nh√©!</div>`;
        body.scrollTop = body.scrollHeight;
      }, 200);
    }
  });

  // ‚ùå ƒê√≥ng
  closeBtn.addEventListener("click", () => {
    chat.classList.remove("active");
    console.log("‚ùå Chat b·ªã ƒë√≥ng");
  });

  // ‚úâÔ∏è G·ª≠i tin nh·∫Øn
  async function sendMessage() {
    const msg = input.value.trim();
    if (!msg) return;
    body.innerHTML += `<div class='user-msg'>${msg}</div>`;
    input.value = "";
    body.scrollTop = body.scrollHeight;

    body.innerHTML += `<div class='ai-msg' id='typing'>ƒêang suy nghƒ©...</div>`;
    body.scrollTop = body.scrollHeight;

    try {
      const res = await fetch("/api/explain", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ question: msg })
      });
      const data = await res.json();
      document.getElementById("typing").remove();
      body.innerHTML += `<div class='ai-msg'>${data.answer}</div>`;
    } catch (e) {
      console.warn("‚ö†Ô∏è L·ªói API:", e);
      document.getElementById("typing").remove();
      body.innerHTML += `<div class='ai-msg'>‚ö†Ô∏è Kh√¥ng th·ªÉ k·∫øt n·ªëi t·ªõi m√°y ch·ªß AI.</div>`;
    }

    body.scrollTop = body.scrollHeight;
  }

  sendBtn.addEventListener("click", sendMessage);
  input.addEventListener("keydown", (e) => {
    if (e.key === "Enter") sendMessage();
  });
});
</script>
</body>
</html>
