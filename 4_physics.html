<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>M√¥ ph·ªèng ph√≥ng x·∫° ‚Äì Chu k·ª≥ b√°n r√£</title>
<style>
  :root {
    --accent: #00eaff;
    --bg: #0b0f16;
    --panel: rgba(255,255,255,0.06);
    --text: #eaf6ff;
  }
  * {box-sizing: border-box; margin: 0; padding: 0; font-family: "Inter", sans-serif;}
  body {
    background: var(--bg);
    color: var(--text);
    display: flex;
    flex-direction: column;
    align-items: center;
    overflow-x: hidden;
  }
  h1 {
    color: var(--accent);
    font-size: 1.8em;
    margin: 20px 0 10px;
    text-shadow: 0 0 10px var(--accent);
  }
  main {
    display: grid;
    grid-template-columns: 1fr 320px;
    gap: 20px;
    width: 90%;
    max-width: 1200px;
    margin-bottom: 20px;
  }
  #simArea {
    background: radial-gradient(circle at center, rgba(0,234,255,0.1), transparent 80%);
    border: 1px solid var(--accent);
    border-radius: 10px;
    box-shadow: 0 0 20px rgba(0,234,255,0.2);
    display: flex;
    justify-content: center;
    align-items: center;
    height: 400px;
    position: relative;
  }
  canvas {
    width: 100%;
    height: 100%;
    border-radius: 10px;
  }
  aside {
    background: var(--panel);
    padding: 15px;
    border-radius: 10px;
    backdrop-filter: blur(6px);
  }
  aside h2 {
    color: var(--accent);
    font-size: 1.2em;
    margin-bottom: 10px;
    border-bottom: 1px solid var(--accent);
    padding-bottom: 4px;
  }
  label { display: block; margin-top: 10px; }
  input, select, button {
    width: 100%;
    margin-top: 5px;
    padding: 6px 8px;
    border: none;
    border-radius: 5px;
  }
  input, select { 
    background: rgba(0,0,0,0.25); 
    color: var(--accent);
  }
  button {
    background: var(--accent);
    color: #000;
    font-weight: bold;
    cursor: pointer;
    margin-top: 10px;
  }
  button:hover { opacity: 0.85; }

  section {
    width: 90%;
    max-width: 1200px;
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-bottom: 30px;
  }
  .panel {
    background: var(--panel);
    padding: 15px;
    border-radius: 10px;
    backdrop-filter: blur(6px);
  }
  .panel h2 {
    color: var(--accent);
    font-size: 1.2em;
    margin-bottom: 8px;
    border-bottom: 1px solid var(--accent);
    padding-bottom: 4px;
  }
  .theory p {margin-bottom: 10px; text-align: justify;}
  .formula {
    background: rgba(0,234,255,0.1);
    border-left: 3px solid var(--accent);
    padding: 8px;
    border-radius: 5px;
    font-family: 'Consolas', monospace;
  }
  #chartArea canvas {
    width: 100%;
    height: 180px;
    background: #09121a;
    border-radius: 8px;
  }
  #remainingCount {
    margin-top: 10px;
    font-size: 1em;
    color: var(--accent);
  }
</style>
</head>
<body>
<h1>M√¥ ph·ªèng hi·ªán t∆∞·ª£ng ph√≥ng x·∫° ‚Äì Chu k·ª≥ b√°n r√£</h1>

<main>
  <div id="simArea">
    <canvas id="simCanvas"></canvas>
  </div>

  <aside>
    <h2>ƒêi·ªÅu khi·ªÉn</h2>
    <label>Lo·∫°i ph√≥ng x·∫°:
      <select id="typeSelect">
        <option value="alpha">Tia Œ± (Alpha)</option>
        <option value="beta">Tia Œ≤ (Beta)</option>
        <option value="gamma">Tia Œ≥ (Gamma)</option>
      </select>
    </label>
    <label>Chu k·ª≥ b√°n r√£ (gi√¢y):
      <input type="number" id="halfLife" value="5" min="1" step="0.1">
    </label>
    <label>Th·ªùi gian m√¥ ph·ªèng (gi√¢y):
      <input type="number" id="duration" value="15" min="1" step="1">
    </label>
    <label>S·ªë h·∫°t ban ƒë·∫ßu (N‚ÇÄ):
      <input type="number" id="particleCount" value="200" min="50" max="500">
    </label>
    <button id="startBtn">B·∫Øt ƒë·∫ßu m√¥ ph·ªèng</button>
    <button id="stopBtn">D·ª´ng</button>
    <div id="remainingCount">S·ªë h·∫°t c√≤n l·∫°i: 0</div>
  </aside>
</main>

<section>
  <div class="panel theory">
    <h2>L√Ω thuy·∫øt</h2>
    <p>Ph√≥ng x·∫° l√† qu√° tr√¨nh trong ƒë√≥ h·∫°t nh√¢n kh√¥ng b·ªÅn v·ªØng t·ª± ph√°t bi·∫øn ƒë·ªïi, ph√°t ra c√°c tia Œ±, Œ≤ ho·∫∑c Œ≥.
    Hi·ªán t∆∞·ª£ng n√†y mang t√≠nh ng·∫´u nhi√™n, nh∆∞ng tu√¢n theo quy lu·∫≠t th·ªëng k√™ x√°c ƒë·ªãnh b·∫±ng ƒë·ªãnh lu·∫≠t ph√≥ng x·∫°.</p>
    <div class="formula">
      N = N‚ÇÄ ¬∑ e<sup>-Œªt</sup>
    </div>
    <p>Trong ƒë√≥:</p>
    <ul>
      <li>N‚ÇÄ: s·ªë h·∫°t nh√¢n ban ƒë·∫ßu</li>
      <li>N: s·ªë h·∫°t nh√¢n c√≤n l·∫°i sau th·ªùi gian t</li>
      <li>Œª: h·∫±ng s·ªë ph√¢n r√£</li>
    </ul>
    <div class="formula">
      T = ln(2) / Œª
    </div>
    <p>v·ªõi T l√† <b>chu k·ª≥ b√°n r√£</b> ‚Äì th·ªùi gian ƒë·ªÉ m·ªôt n·ª≠a s·ªë h·∫°t nh√¢n ph√≥ng x·∫° b·ªã ph√¢n r√£.</p>
  </div>

  <div class="panel" id="chartArea">
    <h2>ƒê·ªì th·ªã ph√¢n r√£</h2>
    <canvas id="chartCanvas"></canvas>
  </div>
</section>

<script>
const canvas = document.getElementById("simCanvas");
const ctx = canvas.getContext("2d");
canvas.width = canvas.clientWidth;
canvas.height = canvas.clientHeight;

let running = false;
let particles = [];
let startTime = 0;
let halfLife = 5;
let duration = 15;
let type = "alpha";
let decayData = [];
let N0 = 200;

// Kh·ªüi t·∫°o h·∫°t ph√¢n t√°n to√†n v√πng
function initParticles(count=N0) {
  particles = [];
  for (let i=0;i<count;i++) {
    particles.push({
      x: Math.random()*canvas.width,
      y: Math.random()*canvas.height,
      angle: Math.random()*Math.PI*2,
      speed: 0,
      active: true
    });
  }
}

function decayProbability(dt) {
  const lambda = Math.log(2)/halfLife;
  return 1 - Math.exp(-lambda * dt);
}

function update(dt) {
  const pDecay = decayProbability(dt);
  for (let p of particles) {
    if (p.active && Math.random() < pDecay) {
      p.active = false;
      p.speed = (type==="alpha")?160:(type==="beta")?180:200;
      p.angle = Math.random()*Math.PI*2;
    }
    if (!p.active) {
      p.x += Math.cos(p.angle)*p.speed*dt;
      p.y += Math.sin(p.angle)*p.speed*dt;
      p.speed *= 0.94;
    }
  }
}

function draw() {
  ctx.fillStyle = "rgba(0,0,0,0.25)";
  ctx.fillRect(0,0,canvas.width,canvas.height);
  for (let p of particles) {
    ctx.beginPath();
    if (p.active) ctx.fillStyle = "#00eaff";
    else ctx.fillStyle = (type==="alpha")?"#ff7b00":(type==="beta")?"#00ff44":"#ffff00";
    ctx.arc(p.x,p.y,2,0,Math.PI*2);
    ctx.fill();
  }
}

let last = 0;
function loop(ts) {
  if (!running) return;
  if (!last) last = ts;
  const dt = (ts - last)/1000;
  last = ts;
  update(dt);
  draw();
  const t = (ts - startTime)/1000;
  const remaining = particles.filter(p=>p.active).length;
  document.getElementById("remainingCount").textContent = "S·ªë h·∫°t c√≤n l·∫°i: " + remaining;
  decayData.push({t, N:remaining});
  if (t < duration) requestAnimationFrame(loop);
  else running = false;
  drawChart();
}

function setBackground(type) {
  const simArea = canvas.parentElement;
  const select = document.getElementById("typeSelect");
  if(type==="alpha") {
    simArea.style.background = "radial-gradient(circle at center, rgba(255,150,80,0.25), transparent 80%)";
  }
  if(type==="beta") {
    simArea.style.background = "radial-gradient(circle at center, rgba(120,255,150,0.25), transparent 80%)";
  }
  if(type==="gamma") {
    simArea.style.background = "radial-gradient(circle at center, rgba(255,255,120,0.25), transparent 80%)";
  }
  select.style.backgroundColor = "rgba(0,0,0,0.25)"; // n·ªÅn t·ªëi
  select.style.color = "#00eaff"; // ch·ªØ n·ªïi
}

function start() {
  type = document.getElementById("typeSelect").value;
  halfLife = parseFloat(document.getElementById("halfLife").value);
  duration = parseFloat(document.getElementById("duration").value);
  N0 = parseInt(document.getElementById("particleCount").value);
  decayData = [];
  initParticles(N0);
  setBackground(type);
  startTime = performance.now();
  running = true;
  last = 0;
  requestAnimationFrame(loop);
}

function stop() { running = false; }

document.getElementById("startBtn").onclick = start;
document.getElementById("stopBtn").onclick = stop;

// ƒê·ªì th·ªã
const chartCanvas = document.getElementById("chartCanvas");
const cctx = chartCanvas.getContext("2d");
chartCanvas.width = chartCanvas.clientWidth;
chartCanvas.height = chartCanvas.clientHeight;

function drawChart() {
  cctx.fillStyle = "#09121a";
  cctx.fillRect(0,0,chartCanvas.width,chartCanvas.height);
  if (decayData.length < 2) return;
  const maxT = duration;
  const maxN = N0;
  cctx.strokeStyle = "#00eaff";
  cctx.beginPath();
  for (let i=0;i<decayData.length;i++) {
    const x = (decayData[i].t/maxT)*chartCanvas.width;
    const y = chartCanvas.height - (decayData[i].N/maxN)*chartCanvas.height;
    if (i===0) cctx.moveTo(x,y);
    else cctx.lineTo(x,y);
  }
  cctx.stroke();
  cctx.fillStyle = "#00eaff";
  cctx.font = "12px Inter";
  cctx.fillText("N(t) = N‚ÇÄ¬∑e^(-Œªt)", 10, 15);
}

drawChart();
</script>

  <!-- N√∫t m·ªü chat -->
<div id="ai-toggle" title="Tr·ª£ l√Ω AI">üí¨</div>

<!-- Khung chat -->
<div id="ai-chat">
  <div class="ai-header">
    <span>Tr·ª£ l√Ω AI</span>
    <button id="ai-close">√ó</button>
  </div>
  <div id="ai-body" class="ai-body"></div>
  <div class="ai-input">
    <input id="ai-text" type="text" placeholder="H·ªèi v·ªÅ th√≠ nghi·ªám n√†y..." />
    <button id="ai-send">‚û§</button>
  </div>
</div>

<style>
/* N√∫t m·ªü */
#ai-toggle {
  position: fixed;
  bottom: 20px;
  right: 20px;
  background: linear-gradient(135deg, #00eaff, #008cff);
  color: #000;
  font-size: 22px;
  padding: 12px;
  border-radius: 50%;
  box-shadow: 0 0 12px #00eaff;
  cursor: pointer;
  transition: transform 0.3s;
  z-index: 999999;
}
#ai-toggle:hover {
  transform: scale(1.15);
}

/* Khung chat */
#ai-chat {
  position: fixed;
  bottom: 80px;
  right: 20px;
  width: 300px;
  background: rgba(0, 0, 0, 0.92);
  border: 1px solid #00eaff;
  border-radius: 15px;
  box-shadow: 0 0 20px #00eaff44;
  display: none;
  flex-direction: column;
  overflow: hidden;
  z-index: 999998;
  transition: all 0.3s ease;
}
#ai-chat.active {
  display: flex !important;
  animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
  from {
    opacity: 0;
    transform: translateY(10px) scale(0.95);
  }
  to {
    opacity: 1;
    transform: translateY(0) scale(1);
  }
}

.ai-header {
  background: #00eaff;
  color: #000;
  font-weight: bold;
  padding: 6px 10px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.ai-header button {
  border: none;
  background: transparent;
  font-size: 20px;
  cursor: pointer;
  color: #000;
}

.ai-body {
  padding: 10px;
  font-size: 13px;
  color: white;
  height: 260px;
  overflow-y: auto;
  background: rgba(255, 255, 255, 0.05);
}
.ai-msg,
.user-msg {
  margin: 6px 0;
  padding: 8px 10px;
  border-radius: 8px;
  line-height: 1.4;
  max-width: 80%;
}
.ai-msg {
  background: #00eaff22;
  text-align: left;
}
.user-msg {
  background: #0088ff44;
  text-align: right;
  margin-left: auto;
}

.ai-input {
  display: flex;
  border-top: 1px solid #00eaff;
}
.ai-input input {
  flex: 1;
  padding: 8px;
  border: none;
  background: transparent;
  color: white;
}
.ai-input button {
  background: #00eaff;
  color: #000;
  border: none;
  padding: 0 12px;
  cursor: pointer;
}
.ai-input button:hover {
  background: #00cfff;
}

canvas, iframe {
  pointer-events: none !important;
}
</style>

<script>
document.addEventListener("DOMContentLoaded", function () {
  console.log("‚úÖ AI chat script loaded");
  const toggle = document.getElementById("ai-toggle");
  const chat = document.getElementById("ai-chat");
  const closeBtn = document.getElementById("ai-close");
  const sendBtn = document.getElementById("ai-send");
  const input = document.getElementById("ai-text");
  const body = document.getElementById("ai-body");
  let greeted = false;

  if (!toggle || !chat) {
    console.error("‚ùå Kh√¥ng t√¨m th·∫•y ph·∫ßn t·ª≠ chat!");
    return;
  }

  // M·ªü & ch√†o
  toggle.addEventListener("click", () => {
    console.log("üí¨ N√∫t chat ƒë∆∞·ª£c b·∫•m");
    chat.classList.toggle("active");
    if (chat.classList.contains("active") && !greeted) {
      greeted = true;
      setTimeout(() => {
        body.innerHTML += `<div class='ai-msg'>üëã Xin ch√†o! M√¨nh l√† tr·ª£ l√Ω AI c·ªßa ph√≤ng th√≠ nghi·ªám.<br>
        M√¨nh c√≥ th·ªÉ gi·∫£i ƒë√°p th·∫Øc m·∫Øc c·ªßa b·∫°n v·ªÅ th√≠ nghi·ªám n√†y</b> nh√©!</div>`;
        body.scrollTop = body.scrollHeight;
      }, 200);
    }
  });

  // ‚ùå ƒê√≥ng
  closeBtn.addEventListener("click", () => {
    chat.classList.remove("active");
    console.log("‚ùå Chat b·ªã ƒë√≥ng");
  });

  // ‚úâÔ∏è G·ª≠i tin nh·∫Øn
  async function sendMessage() {
    const msg = input.value.trim();
    if (!msg) return;
    body.innerHTML += `<div class='user-msg'>${msg}</div>`;
    input.value = "";
    body.scrollTop = body.scrollHeight;

    body.innerHTML += `<div class='ai-msg' id='typing'>ƒêang suy nghƒ©...</div>`;
    body.scrollTop = body.scrollHeight;

    try {
      const res = await fetch("/api/explain", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ question: msg })
      });
      const data = await res.json();
      document.getElementById("typing").remove();
      body.innerHTML += `<div class='ai-msg'>${data.answer}</div>`;
    } catch (e) {
      console.warn("‚ö†Ô∏è L·ªói API:", e);
      document.getElementById("typing").remove();
      body.innerHTML += `<div class='ai-msg'>‚ö†Ô∏è Kh√¥ng th·ªÉ k·∫øt n·ªëi t·ªõi m√°y ch·ªß AI.</div>`;
    }

    body.scrollTop = body.scrollHeight;
  }

  sendBtn.addEventListener("click", sendMessage);
  input.addEventListener("keydown", (e) => {
    if (e.key === "Enter") sendMessage();
  });
});
</script>
</body>
</html>
