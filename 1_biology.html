<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="sl-experiment" content="1_biology" />
    <title>Mô phỏng: Tế bào hành dưới kính hiển vi</title>

    <!-- =============== Styles =============== -->
    <style>
      /* ======= App theme ======= */
      :root {
        --bg: #0b1220;
        --panel: #0f1724;
        --accent: #7fd7ff;
        --muted: #9aa6b2;
        color-scheme: dark;
      }
      @media (prefers-reduced-motion: reduce) {
        * {
          animation: none !important;
          transition: none !important;
        }
      }
      html,
      body {
        height: 100%;
        margin: 0;
        font-family: Inter, Arial, sans-serif;
        background: linear-gradient(180deg, var(--bg) 0%, #071226 100%);
        color: #e6f7ff;
      }
      .app {
        display: grid;
        grid-template-columns: 1fr 360px;
        height: 100vh;
        gap: 18px;
        padding: 18px;
      }
      .viewer {
        background: linear-gradient(180deg, #021026 0%, #06122a 100%);
        border-radius: 14px;
        position: relative;
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      canvas {
        background: radial-gradient(
          circle at 35% 25%,
          #0b2238 0%,
          #071226 30%,
          #02060b 100%
        );
        width: 100%;
        height: 100%;
        display: block;
        touch-action: none; /* tốt cho pan/zoom */
      }
      .hud {
        position: absolute;
        left: 12px;
        top: 12px;
        background: rgba(0, 0, 0, 0.25);
        backdrop-filter: blur(6px);
        padding: 8px 10px;
        border-radius: 10px;
        font-size: 13px;
      }
      .panel {
        background: linear-gradient(180deg, #071226 0%, #06122a 100%);
        border-radius: 12px;
        padding: 14px;
        box-shadow: 0 6px 18px rgba(0, 0, 0, 0.6);
      }
      .controls {
        display: flex;
        flex-direction: column;
        gap: 12px;
        height: 100%;
        overflow-y: auto;
      }
      label {
        font-size: 13px;
        color: var(--muted);
        display: block;
        margin-bottom: 6px;
      }
      input[type="range"] {
        width: 100%;
      }
      .row {
        display: flex;
        gap: 8px;
        align-items: center;
      }
      button {
        background: linear-gradient(180deg, var(--accent), #4fb9d9);
        border: 0;
        padding: 8px 10px;
        border-radius: 8px;
        color: #022;
        cursor: pointer;
        font-weight: 600;
      }
      .muted {
        color: var(--muted);
        font-size: 12px;
      }
      .small {
        font-size: 12px;
      }
      .credit {
        position: absolute;
        right: 12px;
        bottom: 12px;
        font-size: 13px;
        color: var(--muted);
      }
      .legend {
        position: absolute;
        right: 12px;
        top: 12px;
        background: rgba(0, 0, 0, 0.22);
        padding: 8px;
        border-radius: 8px;
        font-size: 13px;
      }

      /* ===== Responsive Mobile ===== */
      @media (max-width: 768px) {
        .app {
          grid-template-columns: 1fr;
          grid-template-rows: auto auto;
          padding: 10px;
          gap: 10px;
        }
        .viewer {
          height: 50vh;
          border-radius: 12px;
        }
        .panel.controls {
          width: 100%;
          max-height: 45vh;
          overflow-y: auto;
          padding: 12px;
          border-radius: 12px;
        }
        button {
          font-size: 16px;
          padding: 10px 14px;
        }
        input[type="range"] {
          height: 28px;
          touch-action: pan-x;
        }
        label,
        .muted,
        .small {
          font-size: 12px;
        }
      }
      /* Landscape mobile */
      @media (max-width: 768px) and (orientation: landscape) {
        .app {
          grid-template-columns: 2fr 1fr;
          grid-template-rows: auto;
          gap: 10px;
        }
        .panel.controls {
          max-height: none;
          height: auto;
        }
        .viewer {
          height: 80vh;
        }
      }
    </style>

    <!-- =============== Chatbox CSS (full) =============== -->
    <style>
      :root {
        --sl-primary: #3b82f6;
        --sl-glow: #60a5fa;
        --sl-bg: rgba(24, 27, 40, 0.55);
        --sl-border: rgba(255, 255, 255, 0.12);
        --sl-text: #e8edf6;
        --sl-sub: #9ba5b8;
      }
      @media (prefers-color-scheme: light) {
        :root {
          --sl-bg: rgba(255, 255, 255, 0.75);
          --sl-border: rgba(0, 0, 0, 0.12);
          --sl-text: #0f172a;
          --sl-sub: #475569;
        }
      }
      @media (prefers-reduced-motion: reduce) {
        * {
          animation: none !important;
          transition: none !important;
        }
      }
      #sl-btn {
        position: fixed;
        right: calc(18px + env(safe-area-inset-right));
        bottom: calc(18px + env(safe-area-inset-bottom));
        height: 54px;
        min-width: 54px;
        padding: 0 18px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, var(--sl-primary), var(--sl-glow));
        color: #fff;
        font: 600 14px system-ui, -apple-system, "Segoe UI", Roboto, Arial,
          sans-serif;
        border-radius: 999px;
        border: 0;
        box-shadow: 0 12px 28px rgba(37, 99, 235, 0.35);
        cursor: pointer;
        z-index: 99998;
        transition: transform 0.18s ease, box-shadow 0.18s ease,
          opacity 0.18s ease;
      }
      #sl-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 18px 36px rgba(37, 99, 235, 0.45);
      }
      #sl-btn:active {
        transform: translateY(0);
      }
      #sl-btn:focus-visible {
        outline: 2px solid var(--sl-glow);
        outline-offset: 2px;
      }
      #sl-wrap {
        position: fixed;
        right: calc(18px + env(safe-area-inset-right));
        bottom: calc(84px + env(safe-area-inset-bottom));
        width: min(
          360px,
          calc(
            100vw - 36px - env(safe-area-inset-right) -
              env(safe-area-inset-left)
          )
        );
        height: 520px;
        display: none;
        flex-direction: column;
        -webkit-backdrop-filter: blur(18px) saturate(150%);
        backdrop-filter: blur(18px) saturate(150%);
        background: var(--sl-bg);
        background: color-mix(in oklab, var(--sl-bg) 85%, black);
        border: 1px solid var(--sl-border);
        border-radius: 20px;
        box-shadow: 0 24px 60px rgba(0, 0, 0, 0.55),
          inset 0 1px 0 rgba(255, 255, 255, 0.05);
        z-index: 99999;
        overflow: hidden;
        animation: sl-pop 0.25s ease;
        transition: height 0.2s ease;
      }
      #sl-wrap.open {
        display: flex;
      }
      #sl-wrap.min {
        height: 120px !important;
      }
      @keyframes sl-pop {
        from {
          opacity: 0;
          transform: translateY(10px) scale(0.97);
        }
        to {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
      }
      #sl-hd {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 12px 14px;
        border-bottom: 1px solid var(--sl-border);
        color: var(--sl-text);
        background: linear-gradient(
          180deg,
          rgba(255, 255, 255, 0.03),
          transparent
        );
      }
      .sl-dot {
        width: 10px;
        height: 10px;
        border-radius: 999px;
        background: #34d399;
        box-shadow: 0 0 8px #34d399aa;
      }
      .sl-title {
        font: 700 14px/1.2 system-ui, -apple-system, "Segoe UI", Roboto, Arial,
          sans-serif;
      }
      .sl-sub {
        font: 500 12px/1 system-ui, -apple-system, "Segoe UI", Roboto, Arial,
          sans-serif;
        color: var(--sl-sub);
      }
      .sl-x {
        margin-left: auto;
        background: none;
        border: 0;
        color: var(--sl-sub);
        cursor: pointer;
        font: 700 16px system-ui, -apple-system, "Segoe UI", Roboto, Arial,
          sans-serif;
      }
      .sl-x:hover {
        color: var(--sl-text);
      }
      .sl-x:focus-visible {
        outline: 2px solid var(--sl-glow);
        outline-offset: 2px;
      }
      #sl-bd {
        flex: 1;
        padding: 14px 14px 2px;
        overflow: auto;
        color: var(--sl-text);
        scroll-behavior: smooth;
        scrollbar-width: thin;
        scrollbar-color: rgba(255, 255, 255, 0.25) transparent;
      }
      #sl-bd::-webkit-scrollbar {
        width: 10px;
      }
      #sl-bd::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.15);
        border-radius: 10px;
      }
      .sl-msg {
        display: flex;
        margin: 8px 0;
      }
      .sl-msg.you {
        justify-content: flex-end;
      }
      .sl-bubble {
        max-width: 78%;
        padding: 10px 12px;
        border-radius: 14px;
        background: rgba(255, 255, 255, 0.08);
        border: 1px solid var(--sl-border);
        box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.04);
        overflow-wrap: anywhere;
      }
      .sl-msg.you .sl-bubble {
        background: linear-gradient(135deg, var(--sl-primary), var(--sl-glow));
        color: #fff;
        border: none;
        box-shadow: 0 8px 20px rgba(59, 130, 246, 0.35);
      }
      .sl-bubble .time {
        opacity: 0.5;
        font: 500 11px system-ui, -apple-system, "Segoe UI", Roboto, Arial,
          sans-serif;
        text-align: right;
        margin-top: 6px;
      }
      #sl-in {
        border-top: 1px solid var(--sl-border);
        padding: 10px;
        display: flex;
        gap: 8px;
        align-items: center;
        background: rgba(0, 0, 0, 0.25);
        flex-wrap: wrap;
      }
      #sl-in textarea {
        order: 0;
        flex: 1 1 auto;
        resize: none;
        height: 42px;
        max-height: 120px;
        padding: 10px 12px;
        border-radius: 12px;
        outline: none;
        color: var(--sl-text);
        background: rgba(255, 255, 255, 0.06);
        border: 1px solid var(--sl-border);
        font: 500 13px system-ui, -apple-system, "Segoe UI", Roboto, Arial,
          sans-serif;
      }
      #sl-in textarea:focus-visible {
        outline: 2px solid var(--sl-glow);
        outline-offset: 2px;
      }
      #sl-in button {
        order: 1;
        height: 42px;
        padding: 0 14px;
        border-radius: 12px;
        border: 0;
        cursor: pointer;
        color: #fff;
        background: linear-gradient(135deg, var(--sl-primary), var(--sl-glow));
        font: 600 13px system-ui, -apple-system, "Segoe UI", Roboto, Arial,
          sans-serif;
        box-shadow: 0 8px 22px rgba(37, 99, 235, 0.35);
        transition: transform 0.15s ease, box-shadow 0.15s ease;
      }
      #sl-in button:hover {
        box-shadow: 0 10px 26px rgba(37, 99, 235, 0.45);
      }
      #sl-in button:active {
        transform: translateY(1px);
      }
      #sl-in button:focus-visible {
        outline: 2px solid var(--sl-glow);
        outline-offset: 2px;
      }
      #sl-in > div {
        order: 2;
        width: 100%;
        display: flex;
        gap: 6px;
        flex-wrap: wrap;
        margin-top: 6px;
      }
      .sl-pill {
        height: 32px;
        display: inline-flex;
        align-items: center;
        padding: 0 12px;
        border-radius: 999px;
        border: 1px solid var(--sl-border);
        background: rgba(255, 255, 255, 0.06);
        color: var(--sl-text);
        font: 600 12px system-ui, -apple-system, "Segoe UI", Roboto, Arial,
          sans-serif;
        cursor: pointer;
      }
      .sl-pill:hover {
        background: rgba(255, 255, 255, 0.1);
      }
      .sl-typing {
        display: flex;
        gap: 6px;
        align-items: center;
      }
      .sl-typing .dot {
        width: 6px;
        height: 6px;
        border-radius: 50%;
        background: #cfe3ff;
        opacity: 0.6;
        animation: blink 1.2s infinite;
      }
      .sl-typing .dot:nth-child(2) {
        animation-delay: 0.2s;
      }
      .sl-typing .dot:nth-child(3) {
        animation-delay: 0.4s;
      }
      @keyframes blink {
        0%,
        80%,
        100% {
          opacity: 0.2;
        }
        40% {
          opacity: 1;
        }
      }
      @media (max-width: 480px) {
        #sl-wrap {
          right: calc(10px + env(safe-area-inset-right));
          left: calc(10px + env(safe-area-inset-left));
          width: auto;
          height: min(70dvh, 560px);
          bottom: calc(80px + env(safe-area-inset-bottom));
        }
        #sl-btn {
          right: calc(12px + env(safe-area-inset-right));
          bottom: calc(12px + env(safe-area-inset-bottom));
        }
      }
    </style>
  </head>

  <body data-experiment="1_biology">
    <div class="app">
      <div class="viewer panel" id="viewer">
        <div class="hud">Magnification: <span id="magLabel">1.0×</span></div>
        <canvas id="scene" width="1200" height="900"></canvas>
        <div class="legend">Scale: <span id="scaleLabel">1 mm</span></div>
        <div class="credit">Mô phỏng: tế bào hành</div>
      </div>

      <div class="panel controls">
        <div>
          <h3 style="margin: 0 0 8px 0">Bảng điều khiển</h3>
          <div class="muted small">
            Ban đầu: quan sát miếng vỏ hành, tăng độ phóng đại để thấy cấu trúc
            tế bào.
          </div>
        </div>

        <div>
          <label>Độ phóng đại</label>
          <input id="mag" type="range" min="1" max="12" step="0.1" value="1" />
          <div class="row">
            <div class="muted">Kéo để phóng đại dần (1× đến 12×)</div>
            <div style="flex: 1"></div>
            <div id="magVal" class="small">1.0</div>
          </div>
        </div>

        <div>
          <label>Ánh sáng</label>
          <input
            id="light"
            type="range"
            min="0"
            max="1"
            step="0.01"
            value="0.9"
          />
          <div class="row">
            <div class="muted">Điều chỉnh cường độ ánh sáng</div>
            <div style="flex: 1"></div>
            <div id="lightVal">90%</div>
          </div>
        </div>

        <div>
          <label>Quan sát ngang</label>
          <input id="viewX" type="range" min="-600" max="600" value="0" />
          <div class="row">
            <div class="muted">Kéo lam kính sang trái/phải</div>
            <div style="flex: 1"></div>
            <div id="viewXVal">0</div>
          </div>
        </div>

        <div>
          <label>Quan sát dọc</label>
          <input id="viewY" type="range" min="-400" max="400" value="0" />
          <div class="row">
            <div class="muted">Kéo lam kính lên/xuống</div>
            <div style="flex: 1"></div>
            <div id="viewYVal">0</div>
          </div>
        </div>

        <div>
          <label>Thuốc nhuộm: Xanh methylen</label>
          <div class="row">
            <button id="stainBtn">Áp dụng thuốc nhuộm</button>
            <button
              id="washBtn"
              style="background: linear-gradient(180deg, #fff, #d8eef7)"
            >
              Rửa
            </button>
          </div>
        </div>

        <div style="margin-top: auto">
          <div class="row">
            <button
              id="reset"
              style="background: linear-gradient(180deg, #f5a3a3, #ff9b9b)"
            >
              Đặt lại
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- =============== Simulation Script (with zoom/pan/shortcuts/culling) =============== -->
    <script>
      const canvas = document.getElementById("scene"),
        ctx = canvas.getContext("2d");
      const clamp = (v, a, b) => Math.min(b, Math.max(a, v));
      let width = canvas.width,
        height = canvas.height;
      let world = { x: 0, y: 0, scale: 1 };
      let cells = [],
        stainLevel = 0,
        light = 0.9;

      function generateCells() {
        cells = [];
        const cellW = 120,
          cellH = 80;
        const cols = Math.ceil((width * 2) / cellW),
          rows = Math.ceil((height * 2) / cellH);
        for (let r = -rows; r < rows * 2; r++) {
          for (let c = -cols; c < cols * 2; c++) {
            const jitter = (Math.random() - 0.5) * 6;
            const x = c * cellW + (r % 2 ? 30 : 0) + jitter;
            const y = r * cellH * 0.98 + (Math.random() - 0.5) * 6;
            const cell = {
              x,
              y,
              w: cellW + (Math.random() - 0.5) * 10,
              h: cellH + (Math.random() - 0.5) * 8,
              nucleus: {
                cx: x + cellW * 0.45 + (Math.random() - 0.5) * 10,
                cy: y + cellH * 0.5 + (Math.random() - 0.5) * 6,
                r: Math.min(cellH, cellW) / 4 + (Math.random() - 0.5) * 6,
              },
              wallThickness: 3 + Math.random() * 2,
              particles: [],
            };
            for (let i = 0; i < 12; i++) {
              cell.particles.push({
                x: x + Math.random() * cellW,
                y: y + Math.random() * cellH,
                r: 1.5 + Math.random() * 1.2,
                angle: Math.random() * Math.PI * 2,
                speed: 0.002 + Math.random() * 0.003,
              });
            }
            cells.push(cell);
          }
        }
      }

      function roundedRect(ctx, x, y, w, h, r) {
        ctx.moveTo(x + r, y);
        ctx.arcTo(x + w, y, x + w, y + h, r);
        ctx.arcTo(x + w, y + h, x, y + h, r);
        ctx.arcTo(x, y + h, x, y, r);
        ctx.arcTo(x, y, x + w, y, r);
      }

      function drawCell(cell) {
        ctx.beginPath();
        roundedRect(ctx, cell.x, cell.y, cell.w, cell.h, 14);
        ctx.lineWidth = cell.wallThickness;
        ctx.strokeStyle = `rgba(220,240,250,${0.85 * light})`;
        ctx.stroke();
        ctx.strokeStyle = `rgba(150,200,230,${0.25 * light})`;
        ctx.lineWidth = 1.2;
        ctx.stroke();

        const grd = ctx.createRadialGradient(
          cell.x + cell.w / 2,
          cell.y + cell.h / 2,
          10,
          cell.x + cell.w / 2,
          cell.y + cell.h / 2,
          Math.max(cell.w, cell.h) / 1.5
        );
        grd.addColorStop(0, `rgba(240,250,255,${0.1 * light})`);
        grd.addColorStop(1, `rgba(180,210,230,${0.05 * light})`);
        ctx.fillStyle = grd;
        ctx.fill();

        ctx.beginPath();
        ctx.ellipse(
          cell.x + cell.w / 2,
          cell.y + cell.h / 2,
          cell.w * 0.45,
          cell.h * 0.35,
          0,
          0,
          Math.PI * 2
        );
        ctx.fillStyle = `rgba(220,235,245,${0.09 * light})`;
        ctx.fill();

        const n = cell.nucleus,
          g2 = ctx.createRadialGradient(n.cx, n.cy, n.r * 0.3, n.cx, n.cy, n.r);
        const base = 60 + Math.floor(120 * stainLevel);
        g2.addColorStop(0, `rgba(40,${base},230,0.8)`);
        g2.addColorStop(
          1,
          `rgba(10,${base - 30},180,${0.55 + stainLevel * 0.35})`
        );
        ctx.beginPath();
        ctx.ellipse(n.cx, n.cy, n.r * 0.9, n.r * 0.7, 0, 0, Math.PI * 2);
        ctx.fillStyle = g2;
        ctx.fill();

        for (const p of cell.particles) {
          p.angle += p.speed;
          const offsetX = Math.sin(p.angle) * 6,
            offsetY = Math.cos(p.angle * 1.2) * 4;
          ctx.beginPath();
          ctx.arc(p.x + offsetX, p.y + offsetY, p.r, 0, Math.PI * 2);
          ctx.fillStyle = `rgba(200,240,255,${0.25 * light})`;
          ctx.fill();
        }
      }

      function draw() {
        ctx.save();
        ctx.clearRect(0, 0, width, height);
        ctx.translate(world.x + width / 2, world.y + height / 2);
        ctx.scale(world.scale, world.scale);
        ctx.translate(-width / 2, -height / 2);

        if (world.scale < 3) {
          ctx.fillStyle = `rgba(200,180,140,${0.8 * light})`;
          ctx.beginPath();
          ctx.ellipse(
            width / 2 / world.scale,
            height / 2 / world.scale,
            300,
            200,
            0,
            0,
            Math.PI * 2
          );
          ctx.fill();
          ctx.fillStyle = `rgba(230,210,170,${0.5 * light})`;
          ctx.fillRect(
            width / 2 / world.scale - 300,
            height / 2 / world.scale - 50,
            600,
            100
          );
        } else {
          // Culling theo viewport để nhẹ CPU/GPU
          const vw = width / world.scale,
            vh = height / world.scale;
          const vx = (width - vw) / 2 - world.x / world.scale;
          const vy = (height - vh) / 2 - world.y / world.scale;
          for (const cell of cells) {
            const m = 40;
            if (cell.x + cell.w < vx - m) continue;
            if (cell.x > vx + vw + m) continue;
            if (cell.y + cell.h < vy - m) continue;
            if (cell.y > vy + vh + m) continue;
            drawCell(cell);
          }
        }
        ctx.restore();
      }

      // ===== UI wiring =====
      const mag = document.getElementById("mag"),
        magVal = document.getElementById("magVal"),
        magLabel = document.getElementById("magLabel");
      const lightSlider = document.getElementById("light"),
        lightVal = document.getElementById("lightVal");
      const stainBtn = document.getElementById("stainBtn"),
        washBtn = document.getElementById("washBtn");
      const reset = document.getElementById("reset"),
        scaleLabel = document.getElementById("scaleLabel");
      const viewX = document.getElementById("viewX"),
        viewY = document.getElementById("viewY");
      const viewXVal = document.getElementById("viewXVal"),
        viewYVal = document.getElementById("viewYVal");

      function updateScaleLabel() {
        const z = world.scale;
        let label = "1 mm";
        if (z >= 2.5 && z < 5) label = "200 µm";
        else if (z >= 5 && z < 9) label = "100 µm";
        else if (z >= 9) label = "50 µm";
        scaleLabel.textContent = label;
      }

      mag.addEventListener("input", () => {
        const val = parseFloat(mag.value);
        world.scale = val;
        magVal.textContent = val.toFixed(1);
        magLabel.textContent = val.toFixed(1) + "×";
        updateScaleLabel();
      });
      lightSlider.addEventListener("input", () => {
        light = parseFloat(lightSlider.value);
        lightVal.textContent = Math.round(light * 100) + "%";
      });
      viewX.addEventListener("input", () => {
        world.x = parseFloat(viewX.value);
        viewXVal.textContent = viewX.value;
      });
      viewY.addEventListener("input", () => {
        world.y = parseFloat(viewY.value);
        viewYVal.textContent = viewY.value;
      });

      stainBtn.addEventListener("click", () => {
        stainBtn.disabled = true;
        stainBtn.textContent = "Đang nhuộm...";
        const t0 = Date.now(),
          dur = 3000;
        const anim = setInterval(() => {
          const p = Math.min(1, (Date.now() - t0) / dur);
          stainLevel = p;
          if (p >= 1) {
            clearInterval(anim);
            stainBtn.disabled = false;
            stainBtn.textContent = "Áp dụng thuốc nhuộm";
          }
        }, 33);
      });
      washBtn.addEventListener("click", () => {
        const start = stainLevel,
          t0 = Date.now(),
          dur = 2000;
        const anim = setInterval(() => {
          const p = Math.min(1, (Date.now() - t0) / dur);
          stainLevel = start * (1 - p);
          if (p >= 1) clearInterval(anim);
        }, 33);
      });
      reset.addEventListener("click", () => {
        world = { x: 0, y: 0, scale: 1 };
        mag.value = 1;
        magVal.textContent = "1.0";
        magLabel.textContent = "1.0×";
        lightSlider.value = 0.9;
        lightVal.textContent = "90%";
        viewX.value = 0;
        viewXVal.textContent = 0;
        viewY.value = 0;
        viewYVal.textContent = 0;
        stainLevel = 0;
        updateScaleLabel();
      });

      function resizeCanvas() {
        const rect = canvas.getBoundingClientRect();
        width = canvas.width = Math.max(800, Math.floor(rect.width * 1.25));
        height = canvas.height = Math.max(600, Math.floor(rect.height * 1.25));
        generateCells();
      }
      window.addEventListener("resize", resizeCanvas);
      resizeCanvas();

      // Wheel zoom giữ điểm dưới con trỏ
      canvas.addEventListener(
        "wheel",
        (e) => {
          e.preventDefault();
          const rect = canvas.getBoundingClientRect();
          const mx = (e.clientX - rect.left) * (width / rect.width);
          const my = (e.clientY - rect.top) * (height / rect.height);
          const old = world.scale;
          const factor = Math.exp((-e.deltaY / 120) * 0.12);
          const next = clamp(old * factor, 1, 12);
          const k = next / old;
          world.x = (world.x + mx - width / 2) * k - (mx - width / 2);
          world.y = (world.y + my - height / 2) * k - (my - height / 2);
          world.scale = next;
          mag.value = next.toFixed(1);
          mag.dispatchEvent(new Event("input"));
        },
        { passive: false }
      );

      // Kéo để pan (desktop + mobile)
      let panning = false,
        start = { x: 0, y: 0 },
        startWorld = { x: 0, y: 0 };
      const onDown = (e) => {
        panning = true;
        const pt = e.touches?.[0] || e;
        start = { x: pt.clientX, y: pt.clientY };
        startWorld = { x: world.x, y: world.y };
        canvas.setPointerCapture?.(e.pointerId || 1);
      };
      const onMove = (e) => {
        if (!panning) return;
        const pt = e.touches?.[0] || e;
        const dx = pt.clientX - start.x,
          dy = pt.clientY - start.y;
        const damp = 1 / world.scale;
        world.x = startWorld.x + dx * damp;
        world.y = startWorld.y + dy * damp;
        viewX.value = Math.round(world.x);
        viewXVal.textContent = viewX.value;
        viewY.value = Math.round(world.y);
        viewYVal.textContent = viewY.value;
      };
      const onUp = () => {
        panning = false;
      };
      canvas.addEventListener("mousedown", onDown);
      canvas.addEventListener("mousemove", onMove);
      window.addEventListener("mouseup", onUp);
      canvas.addEventListener("touchstart", onDown, { passive: true });
      canvas.addEventListener("touchmove", onMove, { passive: true });
      canvas.addEventListener("touchend", onUp, { passive: true });

      // Phím tắt
      window.addEventListener("keydown", (e) => {
        const step = Math.round(20 / world.scale);
        if (e.key === "ArrowLeft") {
          world.x -= step;
          viewX.value = world.x;
          viewXVal.textContent = world.x;
        }
        if (e.key === "ArrowRight") {
          world.x += step;
          viewX.value = world.x;
          viewXVal.textContent = world.x;
        }
        if (e.key === "ArrowUp") {
          world.y -= step;
          viewY.value = world.y;
          viewYVal.textContent = world.y;
        }
        if (e.key === "ArrowDown") {
          world.y += step;
          viewY.value = world.y;
          viewYVal.textContent = world.y;
        }
        if (e.key.toLowerCase() === "r") {
          document.getElementById("reset").click();
        }
      });

      function loop() {
        draw();
        requestAnimationFrame(loop);
      }

      (function init() {
        generateCells();
        updateScaleLabel();
        loop();
      })();
    </script>

    <script defer src="chatbox/chatbox.js"></script>
  </body>
</html>
