<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <title>M√¥ ph·ªèng t√°c ƒë·ªông c·ªßa thu·ªëc kh√°ng sinh</title>

    <style>
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
      }

      body {
        min-height: 100vh;
        background: #0f172a;
        color: #e5e7eb;
        padding: 16px;
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      /* ===== HEADER ===== */

      .header-section {
        max-width: 960px;
        width: 100%;
        text-align: center;
        margin-bottom: 22px;
        padding: 0 12px;
      }

      .main-title {
        font-size: clamp(22px, 4vw, 32px);
        font-weight: 700;
        color: #f8fafc;
        margin-bottom: 8px;
        word-break: break-word;
      }

      .main-description {
        font-size: clamp(13px, 2.8vw, 15px);
        color: #e2e8f0;
        line-height: 1.55;
        word-break: break-word;
      }

      /* ===== APP WRAPPER ===== */

      .app {
        background: #020617;
        border-radius: 16px;
        padding: 24px;
        width: 960px;
        max-width: 100%;
        display: grid;
        grid-template-columns: 1.1fr 1fr;
        gap: 24px;
        box-shadow: 0 24px 60px rgba(0, 0, 0, 0.75);
      }

      @media (max-width: 900px) {
        body {
          padding: 10px;
        }
        .app {
          grid-template-columns: 1fr;
          padding: 16px;
          gap: 16px;
        }
        /* ƒê∆∞a v√πng m√¥ ph·ªèng (ƒëƒ©a) L√äN TR∆Ø·ªöC kh·ªëi ch·ªØ tr√™n mobile */
        .visual {
          order: -1;
          margin-bottom: 10px;
        }
      }

      @media (max-width: 640px) {
        .app {
          padding: 14px;
        }
        button {
          font-size: 12px;
          padding: 7px 8px;
        }
      }

      .controls {
        margin-top: 10px;
        margin-bottom: 18px;
        padding: 14px 16px;
        border-radius: 12px;
        background: radial-gradient(
            circle at top left,
            rgba(59, 130, 246, 0.12),
            transparent
          ),
          rgba(15, 23, 42, 0.9);
        border: 1px solid rgba(148, 163, 184, 0.15);
      }

      .control-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
        flex-wrap: wrap;
        gap: 6px;
      }

      .label {
        font-size: 13px;
        color: #e5e7eb;
        word-break: break-word;
      }

      .value-pill {
        font-size: 12px;
        padding: 4px 8px;
        border-radius: 999px;
        background: rgba(15, 23, 42, 0.9);
        border: 1px solid rgba(148, 163, 184, 0.5);
        min-width: 70px;
        text-align: center;
      }

      input[type="range"] {
        width: 100%;
        margin-top: 4px;
        cursor: pointer;
      }

      .buttons {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        margin-top: 12px;
      }

      button {
        flex: 1 1 calc(50% - 8px);
        padding: 8px 10px;
        border-radius: 999px;
        border: none;
        cursor: pointer;
        font-size: 13px;
        transition: 0.15s ease;
        min-width: 0;
        /* CHO PH√âP XU·ªêNG D√íNG */
        white-space: normal;
        word-break: break-word;
        text-align: center;
      }

      button:active:not(:disabled) {
        transform: scale(0.97);
      }

      button:disabled {
        opacity: 0.6;
        cursor: default;
      }

      #btnStart {
        background: linear-gradient(135deg, #22c55e, #15803d);
        color: white;
        font-weight: 600;
      }

      #btnAddPill {
        background: linear-gradient(135deg, #facc15, #eab308);
        color: #1f2937;
        font-weight: 600;
      }

      #btnAddPill.placing {
        background: linear-gradient(135deg, #f97316, #facc15);
      }

      #btnRemovePill {
        background: linear-gradient(135deg, #ef4444, #f97316);
        color: #fff7ed;
        font-weight: 600;
      }

      #btnRemovePill.removing {
        background: linear-gradient(135deg, #dc2626, #f97316);
      }

      #btnReset {
        background: rgba(15, 23, 42, 1);
        border: 1px solid rgba(148, 163, 184, 0.4);
        color: #e5e7eb;
      }

      /* ===== STATS ===== */

      .stats {
        padding: 14px;
        border-radius: 12px;
        background: rgba(15, 23, 42, 0.9);
        border: 1px solid rgba(148, 163, 184, 0.2);
        margin-top: 10px;
      }

      .stats-row {
        margin-bottom: 10px;
      }

      .stats-label {
        font-size: 11px;
        color: #cbd5e1;
        /* b·ªè all-caps ƒë·ªÉ ch·ªØ VN ƒë·ª° x·∫•u, ƒë·ª° c·∫£m gi√°c m·∫•t ch·ªØ */
        text-transform: none;
        letter-spacing: 0.01em;
        margin-bottom: 2px;
        word-break: break-word;
      }

      .stats-value {
        font-size: 13px;
        word-break: break-word;
      }

      /* ===== EXPLAIN ===== */

      .explain {
        margin-top: 12px;
        padding: 14px;
        border-radius: 12px;
        background: linear-gradient(
          135deg,
          rgba(30, 64, 175, 0.35),
          rgba(15, 23, 42, 0.9)
        );
        border: 1px solid rgba(129, 140, 248, 0.35);
        font-size: 13px;
        line-height: 1.5;
        word-break: break-word;
      }

      .explain-title {
        font-size: 13px;
        font-weight: 600;
        color: #c7d2fe;
        margin-bottom: 6px;
        text-transform: none;
        letter-spacing: 0.02em;
        word-break: break-word;
      }

      /* ===== HINT ===== */

      .hint {
        margin-top: 10px;
        padding: 10px 12px;
        border-radius: 10px;
        background: rgba(15, 23, 42, 0.8);
        border: 1px dashed rgba(148, 163, 184, 0.5);
        font-size: 12px;
        line-height: 1.5;
        word-break: break-word;
      }

      .hint b {
        color: #fde047;
      }

      /* ===== VISUAL AREA ===== */

      .visual {
        display: flex;
        justify-content: center;
        align-items: center;
      }

      .dish {
        width: min(280px, 70vw);
        aspect-ratio: 1 / 1;
        border-radius: 50%;
        background: radial-gradient(circle at 30% 30%, #1e293b, #020617);
        border: 4px solid rgba(148, 163, 184, 0.6);
        box-shadow: 0 0 0 6px rgba(15, 23, 42, 1),
          0 22px 40px rgba(0, 0, 0, 0.8);
        position: relative;
        overflow: hidden;
      }

      .bacteria-layer {
        position: absolute;
        inset: 16px;
        border-radius: 50%;
        overflow: hidden;
      }

      .bacterium {
        position: absolute;
        width: 12px;
        height: 4px;
        border-radius: 999px;
        transform-origin: center;
        transition: opacity 0.2s;
      }

      .bacterium.sensitive {
        background: #bbf7d0;
        box-shadow: 0 0 4px rgba(74, 222, 128, 0.7);
      }

      .bacterium.resistant {
        background: #fecaca;
        box-shadow: 0 0 4px rgba(248, 113, 113, 0.7);
      }

      .antibiotic-pill {
        width: 34px;
        height: 14px;
        position: absolute;
        transform: translate(-50%, -50%);
        border-radius: 999px;
        background: linear-gradient(90deg, #facc15, #fbbf24);
        border: 2px solid #92400e;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.4);
        cursor: pointer;
      }

      .antibiotic-pill::before {
        content: "";
        position: absolute;
        left: 50%;
        top: 0;
        bottom: 0;
        width: 1px;
        background: rgba(0, 0, 0, 0.35);
      }

      .conc-indicator {
        position: absolute;
        bottom: 8px;
        left: 50%;
        transform: translateX(-50%);
        font-size: 11px;
        padding: 4px 8px;
        border-radius: 999px;
        background: rgba(15, 23, 42, 0.85);
        border: 1px solid rgba(148, 163, 184, 0.5);
      }

      @media (max-width: 640px) {
        .app {
          padding: 14px;
        }
        button {
          font-size: 12px;
          padding: 7px 8px;
        }
      }
    </style>
  </head>

  <body>
    <!-- ===== HEADER ===== -->
    <div class="header-section">
      <h1 class="main-title">M√¥ ph·ªèng t√°c ƒë·ªông c·ªßa thu·ªëc kh√°ng sinh</h1>
      <p class="main-description">
        Nh·∫•n <b>‚ÄúB·∫Øt ƒë·∫ßu ·ªß‚Äù</b> ƒë·ªÉ m√¥ ph·ªèng b·∫Øt ƒë·∫ßu ch·∫°y theo th·ªùi gian. Sau ƒë√≥
        thay ƒë·ªïi n·ªìng ƒë·ªô v√† v·ªã tr√≠ kh√°ng sinh ƒë·ªÉ quan s√°t s·ª± thay ƒë·ªïi m·∫≠t ƒë·ªô vi
        khu·∫©n tr√™n ƒëƒ©a th·∫°ch.
      </p>
    </div>

    <!-- ===== APP ===== -->
    <div class="app">
      <!-- LEFT PANEL -->
      <div>
        <div class="controls">
          <div class="control-row">
            <div class="label">N·ªìng ƒë·ªô kh√°ng sinh</div>
            <div id="txtConc" class="value-pill">0%</div>
          </div>

          <input type="range" id="sliderConc" min="0" max="100" value="0" />

          <div class="buttons">
            <button id="btnStart">B·∫Øt ƒë·∫ßu ·ªß</button>
            <button id="btnAddPill">Th√™m kh√°ng sinh</button>
            <button id="btnRemovePill">B·ªè thu·ªëc kh√°ng sinh</button>
            <button id="btnReset">ƒê·∫∑t l·∫°i</button>
          </div>
        </div>

        <div class="stats">
          <div class="stats-row">
            <div class="stats-label">M·∫≠t ƒë·ªô vi khu·∫©n (t∆∞∆°ng ƒë·ªëi)</div>
            <div id="txtPopulation" class="stats-value">100</div>
          </div>
          <div class="stats-row">
            <div class="stats-label">T·ªëc ƒë·ªô sinh tr∆∞·ªüng (xanh & ƒë·ªè)</div>
            <div id="txtGrowthRate" class="stats-value"></div>
          </div>
          <div class="stats-row">
            <div class="stats-label">ƒê√°p ·ª©ng v·ªõi thu·ªëc</div>
            <div id="txtDeathRate" class="stats-value"></div>
          </div>
        </div>

        <div class="explain">
          <div class="explain-title">Gi·∫£i th√≠ch k·∫øt qu·∫£</div>
          <div id="txtExplain">
            B·∫°n v·ª´a m·ªü m√¥ ph·ªèng. Tr√™n ƒëƒ©a c√≥ vi khu·∫©n nh·∫°y thu·ªëc (xanh) v√† m·ªôt
            t·ª∑ l·ªá nh·ªè vi khu·∫©n kh√°ng thu·ªëc (ƒë·ªè). Hi·ªán ch∆∞a ·ªß, n√™n ch·ªâ th·∫•y ph√¢n
            b·ªë ban ƒë·∫ßu c·ªßa qu·∫ßn th·ªÉ. Nh·∫•n ‚ÄúB·∫Øt ƒë·∫ßu ·ªß‚Äù ƒë·ªÉ quan s√°t ch√∫ng thay ƒë·ªïi
            theo th·ªùi gian.
          </div>
        </div>

        <div class="hint">
          ‚Ä¢ <b>M√¥ h√¨nh vi khu·∫©n</b>: Tr√™n ƒëƒ©a c√≥ c·∫£ vi khu·∫©n nh·∫°y thu·ªëc (m√†u
          xanh) v√† m·ªôt s·ªë √≠t vi khu·∫©n c√≥ kh·∫£ nƒÉng kh√°ng thu·ªëc (m√†u ƒë·ªè). Ch√∫ng
          sinh tr∆∞·ªüng gi·ªëng vi khu·∫©n xanh, nh∆∞ng ch·ªãu ƒë∆∞·ª£c kh√°ng sinh t·ªët
          h∆°n.<br />
          ‚Ä¢ <b>B·∫Øt ƒë·∫ßu ·ªß</b>: nh·∫•n n√∫t ‚ÄúB·∫Øt ƒë·∫ßu ·ªß‚Äù ƒë·ªÉ m√¥ ph·ªèng b·∫Øt ƒë·∫ßu c·∫≠p nh·∫≠t
          li√™n t·ª•c (sau ƒë√≥ n√∫t s·∫Ω ƒë∆∞·ª£c kh√≥a).<br />
          ‚Ä¢ <b>Th√™m kh√°ng sinh</b>: b·∫≠t ch·∫ø ƒë·ªô ƒë·∫∑t, sau ƒë√≥ click l√™n ƒëƒ©a ƒë·ªÉ th√™m
          vi√™n thu·ªëc (t·ªëi ƒëa 10 vi√™n).<br />
          ‚Ä¢ <b>B·ªè thu·ªëc kh√°ng sinh</b>: b·∫≠t ch·∫ø ƒë·ªô x√≥a, r·ªìi click ƒë√∫ng vi√™n
          thu·ªëc mu·ªën b·ªè.<br />
          ‚Ä¢ N·ªìng ƒë·ªô &gt; 65%: vi khu·∫©n nh·∫°y thu·ªëc (xanh) g·∫ßn vi√™n thu·ªëc s·∫Ω m·ªù
          d·∫ßn r·ªìi bi·∫øn m·∫•t; vi khu·∫©n kh√°ng thu·ªëc (ƒë·ªè) v·∫´n c√≤n nhi·ªÅu t·∫ø b√†o s·ªëng
          s√≥t.
        </div>
      </div>

      <!-- RIGHT PANEL -->
      <div class="visual">
        <div class="dish">
          <div id="bacteriaLayer" class="bacteria-layer"></div>
          <div id="concIndicator" class="conc-indicator">Conc: 0%</div>
        </div>
      </div>
    </div>

    <!-- ===== SIMULATION SCRIPT ===== -->
    <script>
      const initialPopulation = 100;
      const INITIAL_BACTERIA = 120;
      const MAX_BACTERIA = 600; // tƒÉng ƒë·ªÉ c√≥ nhi·ªÅu vi khu·∫©n h∆°n

      const RESISTANT_RATIO = 0.1;

      const growthRateSensitive = 0.45;
      const growthRateResistant = 0.45;
      const deathRateSensitive = 0.45;
      const deathRateResistant = deathRateSensitive * 0.15;

      const lowConcThreshold = 0.4;
      const exposureSigma = 50;

      let conc = 0;
      let running = false;
      let lastTime = null;
      let populationApproximation = initialPopulation;

      const sliderConc = document.getElementById("sliderConc");
      const txtConc = document.getElementById("txtConc");
      const txtPopulation = document.getElementById("txtPopulation");
      const txtGrowthRate = document.getElementById("txtGrowthRate");
      const txtDeathRate = document.getElementById("txtDeathRate");
      const btnStart = document.getElementById("btnStart");
      const btnReset = document.getElementById("btnReset");
      const btnAddPill = document.getElementById("btnAddPill");
      const btnRemovePill = document.getElementById("btnRemovePill");
      const concIndicator = document.getElementById("concIndicator");
      const bacteriaLayer = document.getElementById("bacteriaLayer");
      const txtExplain = document.getElementById("txtExplain");

      txtGrowthRate.textContent = `${growthRateSensitive.toFixed(
        2
      )} /s (khi ch∆∞a c√≥ kh√°ng sinh, vi khu·∫©n xanh v√† ƒë·ªè sinh tr∆∞·ªüng g·∫ßn gi·ªëng nhau)`;
      txtDeathRate.textContent =
        "Vi khu·∫©n nh·∫°y thu·ªëc (xanh) ch·∫øt nhanh h∆°n khi c√≥ kh√°ng sinh; vi khu·∫©n kh√°ng thu·ªëc (ƒë·ªè) c√≥ t·ª∑ l·ªá ch·∫øt th·∫•p h∆°n, kh√≥ b·ªã di·ªát ho√†n to√†n.";

      let bacteria = [];
      let pills = [];
      const maxPills = 10;
      let placingPill = false;
      let removingPill = false;
      let hadPillsEver = false;

      function updateExplanation(action) {
        const concPercent = Math.round(conc * 100);
        const hasPills = pills.length > 0;

        if (action === "reset") {
          txtExplain.textContent =
            "M√¥ ph·ªèng v·ª´a ƒë∆∞·ª£c ƒë·∫∑t l·∫°i. Tr√™n ƒëƒ©a c√≥ c·∫£ vi khu·∫©n nh·∫°y thu·ªëc (xanh) v√† m·ªôt t·ª∑ l·ªá nh·ªè vi khu·∫©n kh√°ng thu·ªëc (ƒë·ªè). Hi·ªán ch∆∞a ·ªß. Nh·∫•n ‚ÄúB·∫Øt ƒë·∫ßu ·ªß‚Äù ƒë·ªÉ m√¥ ph·ªèng b·∫Øt ƒë·∫ßu c·∫≠p nh·∫≠t theo th·ªùi gian.";
          return;
        }

        if (action === "startIncubation") {
          if (!hasPills) {
            txtExplain.textContent =
              "B·∫°n v·ª´a b·∫Øt ƒë·∫ßu ·ªß trong ƒëi·ªÅu ki·ªán KH√îNG c√≥ kh√°ng sinh. Vi khu·∫©n xanh v√† ƒë·ªè ƒë·ªÅu nh√¢n l√™n v·ªõi t·ªëc ƒë·ªô t∆∞∆°ng t·ª±, l√†m m·∫≠t ƒë·ªô qu·∫ßn th·ªÉ tƒÉng d·∫ßn trong su·ªët qu√° tr√¨nh ·ªß.";
          } else if (concPercent >= 65) {
            txtExplain.textContent =
              "B·∫°n b·∫Øt ƒë·∫ßu ·ªß khi ƒë√£ c√≥ kh√°ng sinh v√† n·ªìng ƒë·ªô cao (" +
              concPercent +
              "%). G·∫ßn c√°c vi√™n thu·ªëc, vi khu·∫©n nh·∫°y thu·ªëc (xanh) b·ªã ·ª©c ch·∫ø m·∫°nh v√† b·ªã di·ªát d·∫ßn, ch·ªâ c√≤n nhi·ªÅu t·∫ø b√†o ƒë·ªè kh√°ng thu·ªëc s·ªëng s√≥t.";
          } else {
            txtExplain.textContent =
              "B·∫°n b·∫Øt ƒë·∫ßu ·ªß khi ƒë√£ c√≥ kh√°ng sinh v·ªõi n·ªìng ƒë·ªô trung b√¨nh (" +
              concPercent +
              "%). Vi khu·∫©n xanh g·∫ßn vi√™n thu·ªëc b·ªã ·ª©c ch·∫ø, nh∆∞ng kh√¥ng b·ªã qu√©t s·∫°ch ho√†n to√†n; vi khu·∫©n ƒë·ªè ch·ªãu thu·ªëc t·ªët h∆°n n√™n c√≥ nhi·ªÅu t·∫ø b√†o v·∫´n s·ªëng.";
          }
          return;
        }

        if (action === "changeConc") {
          if (!hasPills && concPercent === 0) {
            txtExplain.textContent =
              "Ch∆∞a c√≥ kh√°ng sinh tr√™n ƒëƒ©a v√† n·ªìng ƒë·ªô ƒëang l√† 0%. Khi ·ªß, vi khu·∫©n xanh v√† ƒë·ªè sinh tr∆∞·ªüng b√¨nh th∆∞·ªùng, kh√¥ng ch·ªãu t√°c ƒë·ªông c·ªßa thu·ªëc.";
          } else if (!hasPills && concPercent > 0) {
            txtExplain.textContent =
              "B·∫°n tƒÉng n·ªìng ƒë·ªô kh√°ng sinh, nh∆∞ng hi·ªán CH∆ØA ƒë·∫∑t vi√™n thu·ªëc n√†o tr√™n ƒëƒ©a, n√™n vi khu·∫©n v·∫´n ch∆∞a ti·∫øp x√∫c tr·ª±c ti·∫øp v·ªõi thu·ªëc. Khi th√™m vi√™n thu·ªëc, v√πng quanh vi√™n ƒë√≥ s·∫Ω b·ªã ·∫£nh h∆∞·ªüng.";
          } else if (hasPills && concPercent < 40) {
            txtExplain.textContent =
              "B·∫°n ƒëi·ªÅu ch·ªânh n·ªìng ƒë·ªô kh√°ng sinh ·ªü m·ª©c th·∫•p (" +
              concPercent +
              "%) trong khi ƒë√£ c√≥ vi√™n thu·ªëc tr√™n ƒëƒ©a. Khi ·ªß, thu·ªëc ch·ªâ ·ª©c ch·∫ø nh·∫π v√πng r·∫•t g·∫ßn vi√™n thu·ªëc, ph·∫ßn l·ªõn vi khu·∫©n v·∫´n s·ªëng ƒë∆∞·ª£c.";
          } else if (hasPills && concPercent < 65) {
            txtExplain.textContent =
              "N·ªìng ƒë·ªô kh√°ng sinh ·ªü m·ª©c trung b√¨nh (" +
              concPercent +
              "%). Trong qu√° tr√¨nh ·ªß, vi khu·∫©n nh·∫°y thu·ªëc (xanh) g·∫ßn vi√™n thu·ªëc gi·∫£m m·∫≠t ƒë·ªô r√µ r·ªát; vi khu·∫©n kh√°ng thu·ªëc (ƒë·ªè) v·∫´n c√≤n kh√° nhi·ªÅu t·∫ø b√†o s·ªëng s√≥t.";
          } else {
            txtExplain.textContent =
              "N·ªìng ƒë·ªô kh√°ng sinh ƒëang cao (" +
              concPercent +
              "%). Trong l√∫c ·ªß, v√πng xung quanh vi√™n thu·ªëc tr·ªü th√†nh v√πng ·ª©c ch·∫ø m·∫°nh: vi khu·∫©n xanh b·ªã di·ªát g·∫ßn h·∫øt, ch·ªß y·∫øu c√≤n c√°c t·∫ø b√†o ƒë·ªè kh√°ng thu·ªëc t·ªìn t·∫°i.";
          }
          return;
        }

        if (action === "addPill") {
          if (concPercent === 0) {
            txtExplain.textContent =
              "B·∫°n v·ª´a ƒë·∫∑t th√™m vi√™n kh√°ng sinh nh∆∞ng n·ªìng ƒë·ªô t·ªïng ƒëang l√† 0%. Khi tƒÉng n·ªìng ƒë·ªô v√† ·ªß, v√πng quanh vi√™n thu·ªëc s·∫Ω b·∫Øt ƒë·∫ßu ·ª©c ch·∫ø vi khu·∫©n, ƒë·∫∑c bi·ªát l√† vi khu·∫©n nh·∫°y thu·ªëc (xanh).";
          } else if (concPercent < 40) {
            txtExplain.textContent =
              "B·∫°n v·ª´a ƒë·∫∑t th√™m vi√™n kh√°ng sinh ·ªü n·ªìng ƒë·ªô th·∫•p (" +
              concPercent +
              "%). Trong qu√° tr√¨nh ·ªß, g·∫ßn vi√™n thu·ªëc m·ªõi, vi khu·∫©n xanh b·∫Øt ƒë·∫ßu b·ªã ch·∫≠m sinh tr∆∞·ªüng nh∆∞ng v·∫´n c√≤n nhi·ªÅu t·∫ø b√†o s·ªëng; vi khu·∫©n ƒë·ªè g·∫ßn nh∆∞ kh√¥ng b·ªã ·∫£nh h∆∞·ªüng nhi·ªÅu.";
          } else if (concPercent < 65) {
            txtExplain.textContent =
              "B·∫°n v·ª´a ƒë·∫∑t th√™m vi√™n kh√°ng sinh ·ªü n·ªìng ƒë·ªô trung b√¨nh. Khi ·ªß, v√πng quanh vi√™n thu·ªëc m·ªõi s·∫Ω c√≥ m·∫≠t ƒë·ªô vi khu·∫©n xanh gi·∫£m d·∫ßn, trong khi vi khu·∫©n ƒë·ªè v·∫´n duy tr√¨ ƒë∆∞·ª£c qu·∫ßn th·ªÉ.";
          } else {
            txtExplain.textContent =
              "B·∫°n v·ª´a ƒë·∫∑t th√™m vi√™n kh√°ng sinh khi n·ªìng ƒë·ªô ƒëang cao. Trong l√∫c ·ªß, v√πng quanh vi√™n thu·ªëc m·ªõi s·∫Ω nhanh ch√≥ng m·∫•t g·∫ßn h·∫øt vi khu·∫©n nh·∫°y thu·ªëc, ch·ªß y·∫øu c√≤n c√°c t·∫ø b√†o kh√°ng thu·ªëc (ƒë·ªè) s·ªëng s√≥t.";
          }
          return;
        }

        if (action === "removePill") {
          if (pills.length === 0 && hadPillsEver) {
            txtExplain.textContent =
              "B·∫°n ƒë√£ b·ªè h·∫øt c√°c vi√™n kh√°ng sinh kh·ªèi ƒëƒ©a trong khi m√¥ ph·ªèng v·∫´n ƒëang ·ªß. Nh·ªØng v√πng t·ª´ng c√≥ thu·ªëc ƒë√£ m·∫•t ph·∫ßn l·ªõn vi khu·∫©n nh·∫°y thu·ªëc (xanh); ch·ªâ m·ªôt s·ªë t·∫ø b√†o kh√°ng thu·ªëc (ƒë·ªè) s·ªëng s√≥t v√† s·∫Ω t·ª´ t·ª´ sinh tr∆∞·ªüng tr·ªü l·∫°i theo th·ªùi gian.";
          } else if (pills.length > 0) {
            txtExplain.textContent =
              "B·∫°n v·ª´a b·ªè b·ªõt m·ªôt vi√™n kh√°ng sinh. Trong qu√° tr√¨nh ·ªß, c√°c v√πng v·∫´n c√≤n vi√™n thu·ªëc s·∫Ω ti·∫øp t·ª•c ch·ªãu t√°c ƒë·ªông c·ªßa kh√°ng sinh; nh·ªØng v√πng ƒë√£ b·ªè thu·ªëc s·∫Ω d·∫ßn cho ph√©p vi khu·∫©n ‚Äî ƒë·∫∑c bi·ªát l√† vi khu·∫©n kh√°ng thu·ªëc ‚Äî ph·ª•c h·ªìi.";
          } else {
            txtExplain.textContent =
              "Hi·ªán kh√¥ng c√≤n vi√™n kh√°ng sinh n√†o tr√™n ƒëƒ©a. N·∫øu b·∫°n v·∫´n ƒëang ·ªß, c·∫£ vi khu·∫©n xanh v√† ƒë·ªè s·∫Ω d·∫ßn sinh tr∆∞·ªüng l·∫°i; tuy nhi√™n nh·ªØng t·∫ø b√†o kh√°ng thu·ªëc t·ª´ng s·ªëng s√≥t v·∫´n chi·∫øm l·ª£i th·∫ø ·ªü v√πng ƒë√£ ch·ªãu thu·ªëc.";
          }
          return;
        }

        if (!hadPillsEver) {
          txtExplain.textContent =
            "Ch∆∞a ƒë·∫∑t kh√°ng sinh: vi khu·∫©n nh·∫°y thu·ªëc (xanh) v√† m·ªôt v√†i vi khu·∫©n kh√°ng thu·ªëc (ƒë·ªè) m·ªçc ƒë·ªÅu tr√™n th·∫°ch. Khi ·ªß, c·∫£ hai nh√≥m sinh tr∆∞·ªüng v·ªõi t·ªëc ƒë·ªô t∆∞∆°ng t·ª± nhau n·∫øu kh√¥ng c√≥ thu·ªëc.";
        } else if (pills.length > 0) {
          txtExplain.textContent =
            "ƒêang c√≥ kh√°ng sinh tr√™n ƒëƒ©a: v√πng g·∫ßn vi√™n thu·ªëc, vi khu·∫©n nh·∫°y thu·ªëc (xanh) b·ªã ·ª©c ch·∫ø m·∫°nh ho·∫∑c ch·∫øt, ƒë·∫∑c bi·ªát khi n·ªìng ƒë·ªô cao. Vi khu·∫©n kh√°ng thu·ªëc (ƒë·ªè) ch·ªãu thu·ªëc t·ªët h∆°n n√™n c√≥ nhi·ªÅu t·∫ø b√†o v·∫´n s·ªëng s√≥t v√† ti·∫øp t·ª•c sinh tr∆∞·ªüng khi ·ªß.";
        } else {
          txtExplain.textContent =
            "ƒê√£ t·ª´ng ƒë·∫∑t kh√°ng sinh r·ªìi l·∫•y ra: v√πng quanh v·ªã tr√≠ vi√™n thu·ªëc ƒë√£ m·∫•t ƒëi ph·∫ßn l·ªõn vi khu·∫©n nh·∫°y thu·ªëc. M·ªôt s·ªë vi khu·∫©n kh√°ng thu·ªëc (ƒë·ªè) s·ªëng s√≥t v√† t·ª´ t·ª´ sinh tr∆∞·ªüng tr·ªü l·∫°i trong qu√° tr√¨nh ·ªß, nh∆∞ng ƒë·ªÉ qu·∫ßn th·ªÉ ph·ª•c h·ªìi nh∆∞ ban ƒë·∫ßu c·∫ßn nhi·ªÅu th·ªùi gian h∆°n.";
        }
      }

      function spawnBacterium(x, y, type = "sensitive") {
        const el = document.createElement("div");
        el.className =
          "bacterium " + (type === "resistant" ? "resistant" : "sensitive");
        el.style.left = x + "px";
        el.style.top = y + "px";
        const angle = Math.random() * 180;
        const baseTransform = `translate(-50%, -50%) rotate(${angle}deg)`;
        el.style.transform = baseTransform;
        el.style.opacity = 0.9;
        bacteriaLayer.appendChild(el);

        return { el, x, y, life: 1, baseTransform, type };
      }

      function createBacteria() {
        bacteriaLayer.innerHTML = "";
        bacteria = [];
        pills = [];
        placingPill = false;
        removingPill = false;
        hadPillsEver = false;

        btnAddPill.textContent = "Th√™m kh√°ng sinh";
        btnAddPill.classList.remove("placing");
        btnRemovePill.textContent = "B·ªè thu·ªëc kh√°ng sinh";
        btnRemovePill.classList.remove("removing");

        const rect = bacteriaLayer.getBoundingClientRect();
        const cx = rect.width / 2;
        const cy = rect.height / 2;
        const R = rect.width / 2;

        for (let i = 0; i < INITIAL_BACTERIA; i++) {
          const r = Math.sqrt(Math.random()) * R;
          const theta = Math.random() * 2 * Math.PI;
          const x = cx + r * Math.cos(theta);
          const y = cy + r * Math.sin(theta);
          const type =
            Math.random() < RESISTANT_RATIO ? "resistant" : "sensitive";
          const b = spawnBacterium(x, y, type);
          bacteria.push(b);
        }

        updateExplanation("reset");
      }

      function updateUI(popValue) {
        const concPercent = Math.round(conc * 100);
        txtConc.textContent = concPercent + "%";
        concIndicator.textContent = "Conc: " + concPercent + "%";
        txtPopulation.textContent = Math.round(popValue);
      }

      function resetSimulation() {
        conc = 0;
        sliderConc.value = 0;
        running = false;
        lastTime = null;
        btnStart.disabled = false;
        btnStart.textContent = "B·∫Øt ƒë·∫ßu ·ªß";
        createBacteria();
        populationApproximation = initialPopulation;
        updateUI(populationApproximation);
        updateExplanation("reset");
      }

      btnAddPill.addEventListener("click", () => {
        if (pills.length >= maxPills) {
          alert("ƒê√£ ƒë·∫°t t·ªëi ƒëa 10 vi√™n kh√°ng sinh.");
          placingPill = false;
          btnAddPill.textContent = "Th√™m kh√°ng sinh";
          btnAddPill.classList.remove("placing");
          return;
        }
        removingPill = false;
        btnRemovePill.textContent = "B·ªè thu·ªëc kh√°ng sinh";
        btnRemovePill.classList.remove("removing");

        placingPill = !placingPill;
        if (placingPill) {
          btnAddPill.textContent = "ƒêang ƒë·∫∑t thu·ªëc (click l√™n ƒëƒ©a)";
          btnAddPill.classList.add("placing");
        } else {
          btnAddPill.textContent = "Th√™m kh√°ng sinh";
          btnAddPill.classList.remove("placing");
        }
      });

      btnRemovePill.addEventListener("click", () => {
        if (pills.length === 0) {
          alert("Ch∆∞a c√≥ vi√™n thu·ªëc n√†o ƒë·ªÉ b·ªè.");
          return;
        }
        placingPill = false;
        btnAddPill.textContent = "Th√™m kh√°ng sinh";
        btnAddPill.classList.remove("placing");

        removingPill = !removingPill;
        if (removingPill) {
          btnRemovePill.textContent = "ƒêang ch·ªçn vi√™n ƒë·ªÉ b·ªè";
          btnRemovePill.classList.add("removing");
        } else {
          btnRemovePill.textContent = "B·ªè thu·ªëc kh√°ng sinh";
          btnRemovePill.classList.remove("removing");
        }
      });

      bacteriaLayer.addEventListener("click", (e) => {
        const target = e.target;

        if (removingPill && target.classList.contains("antibiotic-pill")) {
          target.remove();
          pills = pills.filter((p) => p.el !== target);
          if (pills.length === 0) {
            removingPill = false;
            btnRemovePill.textContent = "B·ªè thu·ªëc kh√°ng sinh";
            btnRemovePill.classList.remove("removing");
          }
          updateExplanation("removePill");
          return;
        }

        if (!placingPill) return;
        if (pills.length >= maxPills) {
          alert("ƒê√£ ƒë·∫°t t·ªëi ƒëa 10 vi√™n kh√°ng sinh.");
          placingPill = false;
          btnAddPill.textContent = "Th√™m kh√°ng sinh";
          btnAddPill.classList.remove("placing");
          return;
        }

        const rect = bacteriaLayer.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;

        const cx = rect.width / 2;
        const cy = rect.height / 2;
        const dx = x - cx;
        const dy = y - cy;
        const dist = Math.sqrt(dx * dx + dy * dy);
        if (dist > rect.width / 2) return;

        const pillEl = document.createElement("div");
        pillEl.className = "antibiotic-pill";
        pillEl.style.left = x + "px";
        pillEl.style.top = y + "px";

        bacteriaLayer.appendChild(pillEl);
        pills.push({ el: pillEl, x, y });
        hadPillsEver = true;
        updateExplanation("addPill");

        if (pills.length >= maxPills) {
          alert("ƒê√£ ƒë·∫°t t·ªëi ƒëa 10 vi√™n kh√°ng sinh.");
          placingPill = false;
          btnAddPill.textContent = "Th√™m kh√°ng sinh";
          btnAddPill.classList.remove("placing");
        }
      });

      btnStart.addEventListener("click", () => {
        if (running) return;
        running = true;
        btnStart.disabled = true;
        btnStart.textContent = "ƒêang ·ªß...";
        updateExplanation("startIncubation");
      });

      sliderConc.addEventListener("input", () => {
        conc = sliderConc.value / 100;
        updateUI(populationApproximation);
        updateExplanation("changeConc");
      });

      btnReset.addEventListener("click", resetSimulation);

      function step(timestamp) {
        if (lastTime == null) lastTime = timestamp;
        const dt = (timestamp - lastTime) / 1000;
        lastTime = timestamp;

        let totalLife = 0;

        if (running) {
          const hasPills = pills.length > 0;
          const rect = bacteriaLayer.getBoundingClientRect();
          const pillCenters = pills.map((p) => ({ x: p.x, y: p.y }));
          const newBacteria = [];

          for (let i = bacteria.length - 1; i >= 0; i--) {
            const b = bacteria[i];
            const isResistant = b.type === "resistant";

            let exposure = 0;
            if (hasPills) {
              let minDist = Infinity;
              pillCenters.forEach((pc) => {
                const dx = b.x - pc.x;
                const dy = b.y - pc.y;
                const d = Math.sqrt(dx * dx + dy * dy);
                if (d < minDist) minDist = d;
              });
              exposure = Math.exp(
                -(minDist * minDist) / (2 * exposureSigma * exposureSigma)
              );
            }

            let death = 0;
            let growth = 0;

            const gBase = isResistant
              ? growthRateResistant
              : growthRateSensitive;
            const dBase = isResistant ? deathRateResistant : deathRateSensitive;

            if (hasPills) {
              death = dBase * conc * exposure;
              if (conc < lowConcThreshold) {
                const concFactor = 1 - conc / lowConcThreshold;
                const safeFactor = 1 - exposure;
                growth = gBase * concFactor * safeFactor;
              }
            } else {
              // kh√¥ng c√≥ thu·ªëc: sinh tr∆∞·ªüng ·ªïn ƒë·ªãnh
              growth = gBase * 0.8;
            }

            b.life += (growth - death) * dt;

            if (!isResistant && hasPills && conc > 0.65 && b.life <= 0.05) {
              b.el.remove();
              bacteria.splice(i, 1);
              continue;
            }

            if (isResistant && b.life < 0.1) b.life = 0.1;

            if (b.life < 0) b.life = 0;
            if (b.life > 2.0) b.life = 2.0;

            // Sinh th√™m vi khu·∫©n: d·ªÖ h∆°n, nhi·ªÅu h∆°n
            if (
              !hasPills &&
              conc < 0.3 &&
              b.life > 1.1 &&
              bacteria.length + newBacteria.length < MAX_BACTERIA
            ) {
              const jitterR = 10;
              let nx = b.x + (Math.random() * 2 - 1) * jitterR;
              let ny = b.y + (Math.random() * 2 - 1) * jitterR;

              const cx = rect.width / 2;
              const cy = rect.height / 2;
              const dx = nx - cx;
              const dy = ny - cy;
              const d = Math.sqrt(dx * dx + dy * dy);
              if (d > rect.width / 2 - 5) {
                const ratio = (rect.width / 2 - 5) / d;
                nx = cx + dx * ratio;
                ny = cy + dy * ratio;
              }

              const child = spawnBacterium(nx, ny, b.type);
              b.life = 1.0;
              child.life = 1.0;
              newBacteria.push(child);
            }

            // CH·ªà ƒêI·ªÄU CH·ªàNH ƒê·ªò M·ªú, KH√îNG PH√ìNG TO
            const op = 0.3 + Math.min(Math.max(b.life, 0), 1.5) * 0.4;
            b.el.style.opacity = op;

            totalLife += b.life;
          }

          if (newBacteria.length > 0) {
            bacteria = bacteria.concat(newBacteria);
          }
        } else {
          bacteria.forEach((b) => (totalLife += b.life));
        }

        // üî¢ M·∫¨T ƒê·ªò = S·ªê VI KHU·∫®N TH·ª∞C T·∫æ
        const populationApprox = bacteria.length;
        populationApproximation = populationApprox || initialPopulation;
        updateUI(populationApproximation);

        requestAnimationFrame(step);
      }

      resetSimulation();
      requestAnimationFrame(step);
    </script>
  </body>
</html>
