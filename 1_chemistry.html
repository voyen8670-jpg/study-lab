<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Sim: (CH‚ÇÉCOO)‚ÇÇPb + KI</title>
<style>
  :root{ --bg:#071227; --panel:#0b1520; }
  body{font-family:Inter, Arial, sans-serif;background:linear-gradient(180deg,#031426,#071227);color:#e8f6ff;margin:0;padding:18px;display:flex;justify-content:center}
  .wrap{max-width:980px;width:100%}
  h1{margin:0 0 8px;font-size:18px}
  .bench{display:flex;gap:28px;align-items:flex-end;justify-content:center;margin:16px 0}
  .tube{width:100px;height:300px;border:2px solid rgba(255,255,255,0.08);border-radius:18px 18px 30px 30px;position:relative;overflow:hidden;background:rgba(255,255,255,0.02)}
  .neck{position:absolute;top:-28px;left:calc(50% - 22px);width:44px;height:50px;border-radius:8px;background:rgba(255,255,255,0.03)}
  .liquid{position:absolute;left:0;right:0;bottom:0;height:0;transition:height 1.5s linear, background 3s linear;border-radius:0 0 28px 28px}
  .liquid .precip{position:absolute;left:0;right:0;bottom:0;height:100%;pointer-events:none;overflow:hidden}
  .precip-dot{position:absolute;border-radius:50%;opacity:0.95;box-shadow:0 1px 0 rgba(0,0,0,0.25)}
  .label{position:absolute;top:6px;left:10px;font-size:13px;color:#cfe3ff}
  .caption{text-align:center;margin-top:6px;font-size:14px}
  .controls{margin-top:12px;display:flex;gap:8px;flex-wrap:wrap}
  button{padding:8px 12px;border-radius:8px;border:1px solid rgba(255,255,255,0.1);background:rgba(255,255,255,0.04);color:#e6f5ff;cursor:pointer}
  table{width:100%;border-collapse:collapse;margin-top:12px;color:#dfeeff}
  td,th{padding:6px;border-bottom:1px dashed rgba(255,255,255,0.08);font-size:13px;text-align:left}
  .explain{margin-top:12px;background:rgba(255,255,255,0.03);padding:10px;border-radius:8px;font-size:14px;line-height:1.5}
  pre{background:transparent;color:#dfeeff;padding:6px;font-size:13px}
</style>
</head>
<body>
<div class="wrap">
  <h1>M√¥ ph·ªèng: (CH‚ÇÉCOO)‚ÇÇPb + KI</h1>

  <div class="bench">
    <div style="display:flex;flex-direction:column;align-items:center">
      <div class="tube" id="tubeA">
        <div class="neck"></div>
        <div class="label">·ªêng A</div>
        <div class="liquid" id="liqA" style="background:linear-gradient(180deg,#ffffff,#f9f9f9)">
          <div class="precip"></div>
        </div>
      </div>
      <div class="caption">(CH‚ÇÉCOO)‚ÇÇPb<br><strong>0.5 M, <span id="capA">20</span> mL</strong></div>
    </div>

    <div style="display:flex;flex-direction:column;align-items:center">
      <div class="tube" id="tubeB">
        <div class="neck"></div>
        <div class="label">·ªêng B</div>
        <div class="liquid" id="liqB" style="background:linear-gradient(180deg,#eef3ff,#e9f4ff)">
          <div class="precip"></div>
        </div>
      </div>
      <div class="caption">KI<br><strong>0.5 M, <span id="capB">15</span> mL</strong></div>
    </div>

    <div style="display:flex;flex-direction:column;align-items:center">
      <div class="tube" id="tubeC">
        <div class="neck"></div>
        <div class="label">·ªêng C</div>
        <div class="liquid" id="liqC" style="background:linear-gradient(180deg,#eef3ff,#e9f4ff)">
          <div class="precip" id="precipC"></div>
        </div>
      </div>
      <div class="caption">H·ªón h·ª£p<br><strong><span id="capC">0</span> mL</strong></div>
    </div>
  </div>

  <div class="controls">
    <button id="pourA">R√≥t A ‚Üí C</button>
    <button id="pourB">R√≥t B ‚Üí C</button>
    <button id="reset">ƒê·∫∑t l·∫°i</button>
  </div>

  <table>
    <thead><tr><th>·ªêng</th><th>N·ªìng ƒë·ªô</th><th>Th·ªÉ t√≠ch</th></tr></thead>
    <tbody>
      <tr><td>·ªêng A ((CH‚ÇÉCOO)‚ÇÇPb)</td><td>0.5 M</td><td id="volA">20 mL</td></tr>
      <tr><td>·ªêng B (KI)</td><td>0.5 M</td><td id="volB">15 mL</td></tr>
      <tr><td>·ªêng C (H·ªón h·ª£p)</td><td>‚Äî</td><td id="volC">0 mL</td></tr>
    </tbody>
  </table>

  <div class="explain" id="explain">
    <strong>Gi·∫£i th√≠ch theo thao t√°c</strong>
    <div id="explainText" style="margin-top:6px">
      Chu·∫©n b·ªã: A ‚Äî (CH‚ÇÉCOO)‚ÇÇPb (0.5 M, 20 mL, tr·∫Øng); B ‚Äî KI (0.5 M, 15 mL, kh√¥ng m√†u).<br>
      H√£y r√≥t A v√†/ho·∫∑c B v√†o C. Khi c·∫£ hai c√πng c√≥ trong C, ph·∫£n ·ª©ng x·∫£y ra t·∫°o k·∫øt t·ªßa v√†ng PbI‚ÇÇ.
    </div>
  </div>

  <div class="explain" style="margin-top:8px">
    <strong>Ph∆∞∆°ng tr√¨nh ph·∫£n ·ª©ng:</strong>
    <pre>(CH‚ÇÉCOO)‚ÇÇPb + 2KI ‚Üí PbI‚ÇÇ‚Üì + 2CH‚ÇÉCOOK</pre>
  </div>
</div>

<script>
// Initial fixed volumes (mL)
const INIT = {A:20, B:15, C:0};
let A=INIT.A, B=INIT.B, C=INIT.C;
let c_hasPb=false, c_hasI=false;

const liqA=document.getElementById('liqA');
const liqB=document.getElementById('liqB');
const liqC=document.getElementById('liqC');
const precipC=document.getElementById('precipC');
const capA=document.getElementById('capA');
const capB=document.getElementById('capB');
const capC=document.getElementById('capC');
const volA=document.getElementById('volA');
const volB=document.getElementById('volB');
const volC=document.getElementById('volC');
const explainText=document.getElementById('explainText');

function volToPct(v){ return Math.min(v/40,0.85)*100 + '%'; }
function refreshAll(){
  liqA.style.height=volToPct(A);
  liqB.style.height=volToPct(B);
  liqC.style.height=volToPct(C);
  capA.textContent=Math.round(A);
  capB.textContent=Math.round(B);
  capC.textContent=Math.round(C);
  volA.textContent=Math.round(A)+' mL';
  volB.textContent=Math.round(B)+' mL';
  volC.textContent=Math.round(C)+' mL';
}

// clear precip
function clearPrecip(){ while(precipC.firstChild) precipC.removeChild(precipC.firstChild); }

// Hi·ªáu ·ª©ng k·∫øt t·ªßa PbI2
function checkPbI2Reaction(){
  if(c_hasPb && c_hasI){
    explainText.innerHTML="<strong>Ph·∫£n ·ª©ng Pb¬≤‚Å∫ + I‚Åª x·∫£y ra:</strong> PbI‚ÇÇ v√†ng xu·∫•t hi·ªán!";
    clearPrecip();
    const maxDots=Math.min(80,Math.round(C*3));
    for(let i=0;i<maxDots;i++){
      const dot=document.createElement('div');
      dot.className='precip-dot';
      const size=3+Math.random()*10;
      dot.style.width=size+'px';
      dot.style.height=size+'px';
      dot.style.background='#FFD700';
      dot.style.opacity=0.7+Math.random()*0.3;
      dot.style.left=(5+Math.random()*85)+'%';
      dot.style.bottom='100%';
      precipC.appendChild(dot);
      const delay=400+Math.random()*1200;
      const fallTime=1200+Math.random()*2000;
      const finalBottom=(Math.random()<0.6)?(2+Math.random()*12):(30+Math.random()*80);
      setTimeout(()=>{
        dot.style.transition=`bottom ${fallTime}ms ease-out, transform ${fallTime}ms ease-in-out`;
        dot.style.bottom=finalBottom+'px';
        dot.style.transform=`translateX(${(Math.random()-0.5)*10}px)`;
      },delay);
    }
    liqC.style.background='linear-gradient(180deg,#fffacd,#fff5cc)';
  }
}

// r√≥t
function animatePour(source){
  let amount=(source==='A')?A:B;
  if(amount<=0){ explainText.innerHTML=`·ªêng ${source} ƒë√£ r·ªóng.`; return;}
  if(source==='A') c_hasPb=true; else c_hasI=true;

  explainText.innerHTML=`ƒêang r√≥t ${source} v√†o ·ªëng C...`;
  const steps=15, dt=100;
  const delta=amount/steps;
  let step=0;
  const iv=setInterval(()=>{
    step++;
    const t=Math.min(delta,(source==='A'?A:B));
    if(source==='A'){
      A-=t; C+=t;
      liqC.style.background='linear-gradient(180deg,#ffffff,#f9f9f9)'; // gi·ªØ m√†u tr·∫Øng
    } else {
      B-=t; C+=t;
    }
    refreshAll();
    if(step>=steps){ clearInterval(iv); checkPbI2Reaction(); }
  },dt);
}

document.getElementById('pourA').addEventListener('click',()=>animatePour('A'));
document.getElementById('pourB').addEventListener('click',()=>animatePour('B'));
document.getElementById('reset').addEventListener('click',()=>{
  A=INIT.A; B=INIT.B; C=INIT.C; c_hasPb=false; c_hasI=false;
  clearPrecip();
  liqC.style.background='linear-gradient(180deg,#eef3ff,#e9f4ff)';
  explainText.innerHTML="Chu·∫©n b·ªã: A ‚Äî (CH‚ÇÉCOO)‚ÇÇPb (0.5 M, 20 mL, tr·∫Øng); B ‚Äî KI (0.5 M, 15 mL, kh√¥ng m√†u).<br>H√£y r√≥t A v√†/ho·∫∑c B v√†o C. Khi c·∫£ hai c√πng c√≥ trong C, ph·∫£n ·ª©ng x·∫£y ra t·∫°o k·∫øt t·ªßa v√†ng PbI‚ÇÇ.";
  refreshAll();
});

refreshAll();
</script>

   <!-- N√∫t m·ªü chat -->
<div id="ai-toggle" title="Tr·ª£ l√Ω AI">üí¨</div>

<!-- Khung chat -->
<div id="ai-chat">
  <div class="ai-header">
    <span>Tr·ª£ l√Ω AI</span>
    <button id="ai-close">√ó</button>
  </div>
  <div id="ai-body" class="ai-body"></div>
  <div class="ai-input">
    <input id="ai-text" type="text" placeholder="H·ªèi v·ªÅ th√≠ nghi·ªám n√†y..." />
    <button id="ai-send">‚û§</button>
  </div>
</div>

<style>
/* N√∫t m·ªü */
#ai-toggle {
  position: fixed;
  bottom: 20px;
  right: 20px;
  background: linear-gradient(135deg, #00eaff, #008cff);
  color: #000;
  font-size: 22px;
  padding: 12px;
  border-radius: 50%;
  box-shadow: 0 0 12px #00eaff;
  cursor: pointer;
  transition: transform 0.3s;
  z-index: 999999;
}
#ai-toggle:hover {
  transform: scale(1.15);
}

/* Khung chat */
#ai-chat {
  position: fixed;
  bottom: 80px;
  right: 20px;
  width: 300px;
  background: rgba(0, 0, 0, 0.92);
  border: 1px solid #00eaff;
  border-radius: 15px;
  box-shadow: 0 0 20px #00eaff44;
  display: none;
  flex-direction: column;
  overflow: hidden;
  z-index: 999998;
  transition: all 0.3s ease;
}
#ai-chat.active {
  display: flex !important;
  animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
  from {
    opacity: 0;
    transform: translateY(10px) scale(0.95);
  }
  to {
    opacity: 1;
    transform: translateY(0) scale(1);
  }
}

.ai-header {
  background: #00eaff;
  color: #000;
  font-weight: bold;
  padding: 6px 10px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.ai-header button {
  border: none;
  background: transparent;
  font-size: 20px;
  cursor: pointer;
  color: #000;
}

.ai-body {
  padding: 10px;
  font-size: 13px;
  color: white;
  height: 260px;
  overflow-y: auto;
  background: rgba(255, 255, 255, 0.05);
}
.ai-msg,
.user-msg {
  margin: 6px 0;
  padding: 8px 10px;
  border-radius: 8px;
  line-height: 1.4;
  max-width: 80%;
}
.ai-msg {
  background: #00eaff22;
  text-align: left;
}
.user-msg {
  background: #0088ff44;
  text-align: right;
  margin-left: auto;
}

.ai-input {
  display: flex;
  border-top: 1px solid #00eaff;
}
.ai-input input {
  flex: 1;
  padding: 8px;
  border: none;
  background: transparent;
  color: white;
}
.ai-input button {
  background: #00eaff;
  color: #000;
  border: none;
  padding: 0 12px;
  cursor: pointer;
}
.ai-input button:hover {
  background: #00cfff;
}

canvas, iframe {
  pointer-events: none !important;
}
</style>

<script>
document.addEventListener("DOMContentLoaded", function () {
  console.log("‚úÖ AI chat script loaded");
  const toggle = document.getElementById("ai-toggle");
  const chat = document.getElementById("ai-chat");
  const closeBtn = document.getElementById("ai-close");
  const sendBtn = document.getElementById("ai-send");
  const input = document.getElementById("ai-text");
  const body = document.getElementById("ai-body");
  let greeted = false;

  // ‚úÖ M·ªü chat
  toggle.addEventListener("click", () => {
    chat.classList.toggle("active");
    if (chat.classList.contains("active") && !greeted) {
      greeted = true;
      setTimeout(() => {
        body.innerHTML += `<div class='ai-msg'>üëã Xin ch√†o! M√¨nh l√† tr·ª£ l√Ω AI c·ªßa ph√≤ng th√≠ nghi·ªám.<br>M√¨nh c√≥ th·ªÉ gi·∫£i ƒë√°p th·∫Øc m·∫Øc c·ªßa b·∫°n v·ªÅ th√≠ nghi·ªám n√†y!</div>`;
        body.scrollTop = body.scrollHeight;
      }, 200);
    }
  });

  // ‚ùå ƒê√≥ng chat
  closeBtn.addEventListener("click", () => {
    chat.classList.remove("active");
  });

  // ‚úâÔ∏è G·ª≠i tin nh·∫Øn t·ªõi server Node (Ollama)
  async function sendMessage() {
    const msg = input.value.trim();
    if (!msg) return;

    // Hi·ªÉn th·ªã tin nh·∫Øn ng∆∞·ªùi d√πng
    body.innerHTML += `<div class='user-msg'>${msg}</div>`;
    input.value = "";
    body.scrollTop = body.scrollHeight;

    // Hi·ªÉn th·ªã ‚Äúƒëang suy nghƒ©...‚Äù
    body.innerHTML += `<div class='ai-msg' id='typing'>ƒêang suy nghƒ©...</div>`;
    body.scrollTop = body.scrollHeight;

    try {
      const res = await fetch("http://localhost:3000/api/ask", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ question: msg })
      });

      const data = await res.json();
      document.getElementById("typing").remove();

      if (data.answer) {
        body.innerHTML += `<div class='ai-msg'>${data.answer}</div>`;
      } else {
        body.innerHTML += `<div class='ai-msg'>ü§ñ Xin l·ªói, m√¨nh ch∆∞a hi·ªÉu c√¢u h·ªèi n√†y.</div>`;
      }
    } catch (e) {
      console.error("‚ö†Ô∏è L·ªói API:", e);
      document.getElementById("typing").remove();
      body.innerHTML += `<div class='ai-msg'>‚ö†Ô∏è Kh√¥ng th·ªÉ k·∫øt n·ªëi t·ªõi m√°y ch·ªß AI.</div>`;
    }

    body.scrollTop = body.scrollHeight;
  }

  sendBtn.addEventListener("click", sendMessage);
  input.addEventListener("keydown", (e) => {
    if (e.key === "Enter") sendMessage();
  });
});
</script>
</body>
</html>
